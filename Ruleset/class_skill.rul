# Class & Skill System inspired by XCOM2012/XCOM2/Phoenix Point, written by memmaker

# Final Classes
# Ranger        - str: Movement/Melee,      wkn: Armor, Attack Range
# Grenadier     - str: Armor/Heavy Weapons, wkn: Movement, Accuracy
# Sniper        - str: Damage/Range,        wkn: Health, Melee
# Specialist    - str: Medikits/Support,    wkn: Offense
# Psi Op        - str: Psi,                 wkn: Health, Conventional Weapons

# Final Class Skill list (A=Active,P=Passive) - T = Tested, V = Visualisation needed

# = Ranger
# Initial
#  TA Run & Gun
#  TA Slash
#  TP Blademaster
# Advanced
#  TA Conceal
#  TA Rapid Fire
#  TP Phantom
#  TP Shadowstrike
# Elite
#  A Reaper
#  VTP Untouchable

# = Grenadier
# Initial
#  TA Heavy Rocket
#  TA Rapid Deployment
#  P Shredder
# Advanced 
#  A War Cry
#  TA Rage Burst
#  TP Blast Padding
#  P Mayhem
# Elite
#  A Rupture
#  P Sting Grenades

# = Sniper
# Initial
#  A Headshot
#  A Disabling Shot
#  P Death from above
# Advanced
#  TA Quick Aim
#  TA Double Tap
#  P Aim
#  P Center mass
# Elite
#  A Serial
#  P Alpha Mike Foxtrot

# = Specialist
# Initial
#  TA Paramedic
#  A Aid Protocol
#  P Guardian
# Advanced
#  A Combat Protocol
#  A Interference
#  P Steadfast
#  P Field Surgeon
# Elite
#  A Restoration
#  P Savior
#  P Ever Vigilant

# Possible Skill Types:
# 1. Passive Skills
#    Always active or trigger on specific conditions (via SoldierBonus)
# 2. Active Self
#    Player activated without a target (via Medikit)
# 3. Active Enemy
#    Player activated with an enemy unit as target (via Psi-Amp)
# 4. Item Bound
#    Player activated via scripted item use (eg. Grenades, Firearms)

# Concept:
# Soldiers of each class can be hired for an increased salary.
# Soldiers of can choose to undergo the military molding process, gaining access to their class skills in the process.
# Classed soldiers receive additional active and passive skills for each level of training.
# The active ones are activated with the special icon and the passive ones are always active.
#
# There are three training phases. The initial molding process is the first one.
# Second Phase (or Advanced Training) adds two additional passive and active skills.
# Third Phase (or Elite Training) adds another  passive skill and an elite level active skill.
#
# The elite level active skill has to be activated via the SKILL_AMP usable item.

# So every class ends up with 9 skills if they get promoted to colonel.

# New Concepts:
# Weapon Proficiency
# Light vs. Heavy Versions of Armors
# Class based Armors
# Weapons have only one shot mode (but get special abilities instead?)
# Status effects (bleed, fire, poison, acid)
# Willpower mechanics?


# ideas: have a smoke grenade that applies special states on hit. use newTurn to react on these states-
# gun disabling smoke
# flashbang
# combat drugs
# Instead of mana, pay with morale and have a recover action or recovery on a turn without hits

# NOTE: You can set tags on GeoscapeSoldier in returnFromMissionUnit which you could read back in createUnit.
# NOTE: One item can be used as Armor.SpecialWeapon thus removing the item as long as that armor is worn.

# Symbols: P = Passive Skill, A = Active Skill, E = Elite Level Skill, I = Skill could be bound to item, X = Is implemented
# == Possibly Possible Skills (Not all of these are possible and not all are currently implemented)
# === Ranger
# P Phantom            - Begin a mission in concealment.
# A Dash               - Move to a target position within half of the normal movement range.
# A Run & Gun          - Take an extra action
# A Slash              - A free melee attack with your sword
# P Sprinter           - Grants +4 mobility (roughly 3 tiles movement).
# P Ready For Action   - Reloading and inventory actions do not cost an Action Points
# P Blademaster        - Deal increased damage on all sword attacks.
# A Conceal            - Immediately enter concealment once per mission.
# P Shadowstrike       - While concealed, gain bonus aim and bonus critical chance when attacking enemies.
# P Shadowstep         - This soldier does not trigger overwatch or reaction fire.
# A Rapid Fire         - Fire twice in a row at an enemy. Each shot suffers an Aim penalty of -15.
# P Bladestorm         - Free sword attacks on any enemies that enter or attack from melee range.
# P Untouchable        - If you score a kill during your turn, the next attack against you during the enemy turn will miss. Includes area-of-effect attacks such as grenades.
# A Reaper             - A devastating chain melee attack where the first melee attack cannot miss. Each melee kill in Reaper mode grants an extra action, but further melee attacks deal reduced damage. 4-turn cooldown.
# === Grenadier
# A Heavy Rocket       - Fire a rocket using an equipped launcher. This ability can not be used after moving, nor more than once per mission.
# A Shredder Rocket    - Fire a rocket that causes all enemies hit to take +33% damage from all sources for the next 4 turns. The rocket's blast is weaker than a standard rocket's.
# P Blast Padding      - Your gear includes layers of extra padding and blast plates, granting a bonus point of Armor and 66% less damage from explosive attacks.
# P Will to Survive    - Reduces all normal damage taken by 2 if not flanked.
# A War Cry            - All enemies within 10 tiles have their Action Points Reduced to 50% for the next turn.
# P Shredder           - Your cannon attacks shred armor. Higher rank weapons shred more points of armor. The shredding effect applies before damage.
# P Mayhem             - Confers additional damage to all area of effect weapons & Auto Shooting Guns
# P Platform Stability - Shots taken before any costly actions have +10 Aim and +10% critical chance. Also grants +10 aim for purposes of reducing scatter if the soldier has not moved this turn
# P Extra Conditioning - Confers bonus health + strength based on which type of armor is equipped. Heavier armor increases the bonus.
# A Rapid Deployment m - Activate this ability before throwing or launching a support grenade, and the throw will not cost an action.
# P HEAT Warheads      - Your grenades now pierce armor and shred additional points of armor.
# P Sting Grenades     - Your flashbang grenades have a 50% chance to stun enemies for one turn in the flashbang's Area of Effect.
# A Rage Burst         - Shoot with a proficient direct-fire projectile weapon, using all remaining ammo in the weapon's magazine.
# A Rupture            - A Rupture shot deals critical damage and ensures that the target takes an additional +3 damage from all attacks in the future. Uses 3 ammo. 3-turn cooldown.
# === Sniper
# A Lightning Hands    - Fire your pistol at a target. This attack does not cost an action.
# P Sharpshooter       - +10 critical chance in all situations, +10 Aim
# A Headshot           - Fire a shot with +30% critical chance and extra damage on critical hits.
# P Steady Hands       - If you did not move last turn, gain +10 Aim and +10 Critical chance.
# A Disabling Shot     - Allows sniper rifles to fire a shot that causes the target's main weapon to malfunction. The target may use Reload to fix the weapon. 2 turn cooldown. Cannot cause critical hits.
# P Death from Above   - Killing an enemy at a lower elevation with your sniper rifle costs only a single action, and does not end your turn.
# P Aim                - Kneel now confers +20 Aim to the first shot on the following turn.
# A Double Tap         - Fire a standard shot and gain a bonus shot or overwatch action.
# P Center Mass        - You do additional points of base damage when using guns.
# P Alpha Mike Foxtrot - You do 4 additional points of base damage and 2 additional points of crit damage with your primary weapon.
# A Fan Fire           - Fire the pistol three times at the same target.
# A Mark For Death     - Mark enemy target. Until end of the turn all damage to that  target is increased by 50%.
# A Serial             - A powerful chained shot ability. For every kill made with your sniper rifle, your actions will be refunded. Critical chance decreases per chained kill. 4 turn cooldown.
# === Specialist
# A Aid Protocol       - It grants that target a bonus to Defense until the start of the next player turn. The basic Gremlin grants +20 Defense.
# P Field Surgeon      - Reduces (or, for 1 HP flesh wounds, eliminates) Wounded timer on soldiers who sustained HP damage but were not Critically Wounded. Does not affect wound sustained by sending fatigued soldier on a mission.
# P Sprinter           - Grants +4 mobility (roughly 3 tiles movement).
# P Steadfast          - Never panic as a result of getting wounded, allies panicking, allies getting wounded or killed, or the intimidation ability.
# P Revive             - Allows Medikits to revive critically wounded Soldiers at 33% of maximum health instead of just stabilizing them.
# P Paramedic          - Once per turn, this unit may use a medikit without spending an action.
# P Ever Vigilant      - If you spend all your actions on moves, you are granted an automatic overwatch shot at the end of the turn.
# P Guardian           - With every successful Overwatch shot, there is a 50% chance that another shot will be taken.
# P Combat Drugs       - Smoke grenades confer +20 Will and +20% critical chance in addition to the original 20 defense. The area of effect is also increased by 25%.
# P Savior             - Medikits restore health per use.
# A Electric Reinforcement - All allies gain 20 temporary Armor for 1 turn
# A Restoration        - Each squad member is healed or revived as needed.
# === Psi 
# Panic
# Inspire            - Give all your TU (>75%) in order to restore TU of an ally
# Mind Merge         - Grants bonus will, crit and ablative hit points to an ally until the beginning of the player's next turn.
# Stasis             - No damage received and no action possible for one turn
# Soul Fire          - Guaranteed Psi Damage
# Soul Steal         - Damage enemy and heal the user
# Mind Sense         - All organic enemies within 15 tiles are automatically reveled
# Mind Control
# Mind Crush         - Deal 100 damage to all enemy entities within 10 tiles
# === Other
# X Sustain          - Instead of being killed, go into stasis with 1 hp once per mission
# X Executioner      - Increased damage against targets with HP < 50%

# Genetics Lab Projects (Not implemented yet)
# Neural Dampening      - Confers +20 Will when defending against psi attacks, and immunity to panic. If the soldier is Mind Controlled, the control is cancelled, and the soldier is stunned for 1 turn instead.
# Neural Feedback       - Causes damage to psi attackers and puts all of their psi attacks on cooldown. Does not reduce the attacker's chance of success.
# Hyper Reactive Pupils - Confers +10 Aim to any shot after a miss.
# Secondary Heart       - Causes soldiers to bleed out instead of dying the first time they go to zero health during a mission. The bleed out timer is extended for 2 turns. Prevents loss of will from critical wounds.
# Adrenal Neurosymathy  - Overloads the soldiers adrenal glands: when a kill is confirmed the soldier emits pheromones that grant offensive benefits to all nearby squad mates. Cannot occur more than once on every 5 turns.
# Adaptive Bone Marrow  - Soldier regenerates 2 HP per turn up to the HP max without armor.
# Iron Skin             - All damage taken is reduced by 25%.
# Adrenaline Surge      - Confers +10 Aim and +10% critical chance. Activated on getting wounded.

# == Possible Item Skills (Not implemented yet)
# === Shotguns
# Rapid Fire       - Fire twice in a row at an enemy. Each shot suffers an Aim penalty of -15. There is no cooldown on this ability.
# === Rocket Launchers
# Shredder Rocket  - Fire a rocket that causes all enemies hit to take +33% damage from all sources for the next 4 turns. The rocket's blast is weaker than a standard rocket's. (4 Damage)
# === Sniper Rifles
# Deadeye          - Take a shot with a small aim penalty for a significant damage boost. 2 turn cooldown.
# Precision Shot   - Take a special shot with +30 bonus to critical chance and 33% bonus critical damage. Three-turn cooldown.
# === Machine Guns
# Demolition       - Unleash a volley of bullets at your target's cover, significantly damaging or destroying it. Deals no damage to your target. Uses 2 ammo. 3-turn cooldown.
# === Ammo
# Venom Rounds	   - increased damage, chance to poison the target
# Talon Rounds	   - +20% critical chance, increased critical damage
# Dragon Rounds	   - increased damage, chance to inflict burning
# === Utility
# Mimic Beacon     - Conjures a holographic decoy soldier for the enemy to shoot at.

# Possible Item effects:
# Chance to inflict burning/poison/acid/etc. and stasis/stun/exhausted/rupture/etc.
# Critical chance/damage
# Shred armor (via rules)
# Destroy environment
# Boost damage for specific shot type (snap/auto/aimed/etc.)
# Body part targeting
# Vampiric

# TESTING SETUP
#startingBase:
#  randomSoldiers:
#    STR_SOLDIER: 2
#    STR_PILOT: 4
#    STR_RANGER: 2
#    STR_GRENADIER: 2
#    STR_SPECIALIST: 2
#    STR_SNIPER: 2
#    STR_PSI_OPERATIVE: 2

# CQC
enableCloseQuartersCombat: 1       # default is 0 to disable this new code, 1 enables it
closeQuartersAccuracyGlobal: 65    # default 100, this sets the default weapon close quarters combat
closeQuartersTuCostGlobal: 12      # TUs required to attempt CQC; unsuccessful attempt doesn't spend the TUs, successful does
closeQuartersEnergyCostGlobal: 8   # Energy required to attempt CQC; unsuccessful attempt doesn't spend the Energy, successful does

# Mana / Battle Focus
mana:
  enabled: true
  battleUI: true
  trainingPrimary: false
  trainingSecondary: false
  replenishAfterMission: true

commendations:
  - type: STR_SOLDIER_EXPERIENCE
    description: STR_SOLDIER_EXPERIENCE_DESCRIPTION
    sprite: 1
    criteria:
      totalKills: [2, 4, 4, 4, 6, 6, 6, 10, 10, 10]
      totalMissions: [4, 8, 8, 8, 12, 12, 12, 16, 16, 16]

soldierBonuses:
  - name: STR_RANGER_INITIAL_BONUS
    tags:
      BLADEMASTER: 20         #X (1-xxx) flat bonus to power (for attacks with sword)
      RUN_AND_GUN: 1          #X (1/0) on / off, extra action on activation
    recovery:
      energy:
        flatOne: 10
  - name: STR_RANGER_ADVANCED_BONUS
    tags:
      PHANTOM: 5              #X distance threshold for stealth, 5 means enemies can only see you in a 5 tile range
      SHADOWSTRIKE: 10        #X (1-xxx) bonus to crit chance in percent
    recovery:
      energy:
        flatOne: 20
  - name: STR_RANGER_ELITE_BONUS
    tags:
      UNTOUCHABLE: 2          #X (0-n) number of attacks which are deflected after a kill
      REAPER: 1               #X (1/0) 1 = on, 0 = off, TU refund after kill, once per mission
  - name: STR_GRENADIER_INITIAL_BONUS
    tags:
      SHREDDER: 1             #X (1/0) on/off, while using autoshot and shredder enabled weapons, remove additional armor from enemies
      HEAVY_ROCKET: 1         #X tag is currently unused, because the skill is simply a built-in specialWeapon
    recovery:
      stun:
        flatOne: 1
  - name: STR_GRENADIER_ADVANCED_BONUS
    tags:
      BLAST_PADDING: 60       #X (0-100) amount of damage reduction in percent for HE and Incendiary
      MAYHEM: 10              #X (1-xxx) additional power, in percent, of auto shot, he and incendiary attacks
  - name: STR_GRENADIER_ELITE_BONUS
    tags:
      STING_GRENADES: 50      #X (1-xxx) chance to stun enemies when using flashbang, in percent
      RUPTURE: 1              #X (1/0) on/off enables use rupture skill with compatible weapons, (aimed / auto only)
    recovery:
      health:
        flatOne: 1
  - name: STR_SNIPER_INITIAL_BONUS
    tags:
      DEATH_FROM_ABOVE: 1     #X (1/0) on/off enables refund of TU when killing from above, once per turn 
      HEADSHOT: 1             #X (1/0) on/off enables use headshot ability (increased crit chance & damage on next hit)
  - name: STR_SNIPER_ADVANCED_BONUS
    tags:
      AIM: 1                  #X (1/0) enables 30% bonus accuracy when kneeling on the position you were kneeling on the start of the turn
      CENTER_MASS: 20         #X (1-XXX) additional damage in percent with Standard Rifles & Sniper Rifles
  - name: STR_SNIPER_ELITE_BONUS
    tags:
      ALPHA_MIKE_FOXTROT: 20  #X (1-XXX) additional power for all sniper rifle attacks and half of that as additional crit damage
      SERIAL: 1               #X (1/0) enables serial kills with sniper rifles, each kill refunds all TU, once per mission
  - name: STR_SPECIALIST_INITIAL_BONUS
    tags:
      GUARDIAN: 1             #X (1/0) a 50% chance that TU on reaction fire get refunded
      PARAMEDIC: 1            #X tag is currently unused, because the skill is simply a built-in specialWeapon
    recovery:
      morale:
        flatOne: 5
  - name: STR_SPECIALIST_ADVANCED_BONUS
    tags:
      STEADFAST: 50           #X (1-XXX) bonus to bravery and psiDefence
      FIELD_SURGEON: 30       #X (1-XXX) percent reduction in recovery time if healed by field surgeon
    stats:
      bravery: 50
  - name: STR_SPECIALIST_ELITE_BONUS
    tags:
      SAVIOR: 10              #X (1-XXX) flat amount of health restored when using heal
      EVER_VIGILANT: 1        #X (1/0) restores all TU on beginning of enemy turn 

armors:
  - type: STR_NONE_UC
    recovery:
      mana:
        mana: 0.40 # recover 40% of max mana each turn = 3 turn cool down

items:
  - type: STR_HEAVY_ROCKET_SKILL
    tags:
      CLASS_SKILL_ACTIVATION: 1
      SKILL_POWER_ITEM: 1
      SHREDDER_DAMAGE: 10
    bigSprite: 15
    floorSprite: 15
    handSprite: 72
    bulletSprite: 0
    fireSound: 52
    clipSize: 2  # max number of uses per mission
    accuracyAimed: 115
    accuracySnap: 115
    costAimed:
      time: 5
      mana: 12
    costSnap:
      time: 5
      mana: 12
    confAimed:
      shots: 1
      ammoSlot: -1
      arcing: false
    confSnap:
      shots: 1
      ammoSlot: -1
      arcing: false
    flatRate: true
    tuThrow: 0
    battleType: 1
    twoHanded: false
    invWidth: 2
    invHeight: 3
    hitSound: 0
    hitAnimation: 0
    power: 75
    hidePower: true
    damageType: 3
  - type: STR_SKILL_AMP_FRIENDLY_ONLY
    size: 0.1
    costBuy: 2000
    costSell: 194700
    weight: 10
    bigSprite: 33
    floorSprite: 32
    handSprite: 88
    hitSound: 36
    battleType: 9
    twoHanded: false
    psiRequired: false
    invWidth: 1
    invHeight: 3
    flatRate: true
    costUse:
      time: 1
      mana: 12
    costPanic:
      time: 10
      mana: 5
    psiTargetMatrix: 1
    flatRate: true

soldierTransformation:
  - name: STR_RANGER_MOLDING
    soldierBonusType: STR_RANGER_INITIAL_BONUS
    minRank: 0 # rookie
    keepSoldierArmor: true
    createsClone: false
    needsCorpseRecovered: false
    allowsDeadSoldiers: false 
    allowsLiveSoldiers: true
    allowedSoldierTypes:
      - STR_RANGER
    requiredMinStats: #				The minimum stats a soldier must have in order to be eligible for this project, defaults to all 0 so any soldier is eligible
      tu: 50
      stamina: 50
      health: 0
      bravery: 0
      reactions: 0
      firing: 0
      throwing: 0
      strength: 0
      psiStrength: 0
      psiSkill: 0
      melee: 30
    cost: 50000      #				The cost of the project in dollars
    transferTime: 72 #				Soldiers can be put in a transfer back to the base where they started if this parameter is greater than the default of 0 hours. New clones or resurrected soldiers are automatically given a transfer to the base with a default of 24 hours.
    recoveryTime: 3 #				The amount of wound recovery time a soldier is given after this project completes and the transfer, if any, is completed. The default value is 0 days.
    percentOverallStatChange: #			A percent change to the soldier's overall stats when undergoing this project, can be positive or negative - tu: 5 means the soldier will gain an extra 5% of their max time units, while tu: -5 means the soldier will lose 5% of their max time units. The default of 0 means no change.
      tu: 10
      stamina: 10
      health: -5
      bravery: 5
      reactions: 5
      firing: -5
      throwing: -5
      strength: 5
      psiStrength: 0
      psiSkill: -100
      melee: 10
    lowerBoundAtMinStats: true  #		Default true, this parameter determines whether or not any changes in stats from this project should go below the minStats defined on the new soldier type.
    upperBoundAtMaxStats: false #		Default false, this parameter determines whether or not any changes in stats from this project should go above the maxStats defined on the new soldier type.
    upperBoundAtStatCaps: false #		Default false, this parameter determines whether or not any changes in stats from this project should go above the statCaps defined on the new soldier type.
  - name: STR_GRENADIER_MOLDING
    soldierBonusType: STR_GRENADIER_INITIAL_BONUS
    keepSoldierArmor: false
    createsClone: false
    needsCorpseRecovered: false
    allowsDeadSoldiers: false 
    allowsLiveSoldiers: true
    minRank: 0 # rookie
    allowedSoldierTypes:
      - STR_GRENADIER
    requiredMinStats: #				The minimum stats a soldier must have in order to be eligible for this project, defaults to all 0 so any soldier is eligible
      tu: 0
      stamina: 40
      health: 40
      bravery: 0
      reactions: 0
      firing: 0
      throwing: 0
      strength: 30
      psiStrength: 0
      psiSkill: 0
      melee: 0
    cost: 50000      #				The cost of the project in dollars
    transferTime: 72 #				Soldiers can be put in a transfer back to the base where they started if this parameter is greater than the default of 0 hours. New clones or resurrected soldiers are automatically given a transfer to the base with a default of 24 hours.
    recoveryTime: 3 #				The amount of wound recovery time a soldier is given after this project completes and the transfer, if any, is completed. The default value is 0 days.
    percentOverallStatChange: #			A percent change to the soldier's overall stats when undergoing this project, can be positive or negative - tu: 5 means the soldier will gain an extra 5% of their max time units, while tu: -5 means the soldier will lose 5% of their max time units. The default of 0 means no change.
      tu: -10
      stamina: 10
      health: 10
      bravery: 5
      reactions: -15
      firing: -10
      throwing: -5
      strength: 10
      psiStrength: 0
      psiSkill: -100
      melee: 0
    lowerBoundAtMinStats: true  #		Default true, this parameter determines whether or not any changes in stats from this project should go below the minStats defined on the new soldier type.
    upperBoundAtMaxStats: false #		Default false, this parameter determines whether or not any changes in stats from this project should go above the maxStats defined on the new soldier type.
    upperBoundAtStatCaps: false #		Default false, this parameter determines whether or not any changes in stats from this project should go above the statCaps defined on the new soldier type.
  - name: STR_SNIPER_MOLDING
    soldierBonusType: STR_SNIPER_INITIAL_BONUS
    keepSoldierArmor: false
    createsClone: false
    needsCorpseRecovered: false
    allowsDeadSoldiers: false 
    allowsLiveSoldiers: true
    minRank: 0 # rookie
    allowedSoldierTypes:
      - STR_SNIPER
    requiredMinStats: #				The minimum stats a soldier must have in order to be eligible for this project, defaults to all 0 so any soldier is eligible
      tu: 0
      stamina: 0
      health: 0
      bravery: 0
      reactions: 40
      firing: 60
      throwing: 0
      strength: 0
      psiStrength: 0
      psiSkill: 0
      melee: 0
    cost: 50000      #				The cost of the project in dollars
    transferTime: 72 #				Soldiers can be put in a transfer back to the base where they started if this parameter is greater than the default of 0 hours. New clones or resurrected soldiers are automatically given a transfer to the base with a default of 24 hours.
    recoveryTime: 3 #				The amount of wound recovery time a soldier is given after this project completes and the transfer, if any, is completed. The default value is 0 days.
    percentOverallStatChange: #			A percent change to the soldier's overall stats when undergoing this project, can be positive or negative - tu: 5 means the soldier will gain an extra 5% of their max time units, while tu: -5 means the soldier will lose 5% of their max time units. The default of 0 means no change.
      tu: 0
      stamina: 0
      health: -10
      bravery: 5
      reactions: 0
      firing: 20
      throwing: -5
      strength: -5
      psiStrength: 0
      psiSkill: -100
      melee: -20
    lowerBoundAtMinStats: true  #		Default true, this parameter determines whether or not any changes in stats from this project should go below the minStats defined on the new soldier type.
    upperBoundAtMaxStats: false #		Default false, this parameter determines whether or not any changes in stats from this project should go above the maxStats defined on the new soldier type.
    upperBoundAtStatCaps: false #		Default false, this parameter determines whether or not any changes in stats from this project should go above the statCaps defined on the new soldier type.
  - name: STR_PSI_OPERATIVE_MOLDING
    keepSoldierArmor: false
    createsClone: false
    needsCorpseRecovered: false
    allowsDeadSoldiers: false 
    allowsLiveSoldiers: true
    minRank: 1 # squaddie
    allowedSoldierTypes:
      - STR_PSI_OPERATIVE
    requiredMinStats: #				The minimum stats a soldier must have in order to be eligible for this project, defaults to all 0 so any soldier is eligible
      tu: 0
      stamina: 0
      health: 0
      bravery: 0
      reactions: 0
      firing: 0
      throwing: 0
      strength: 0
      psiStrength: 65
      psiSkill: 0
      melee: 0
    cost: 50000      #				The cost of the project in dollars
    transferTime: 72 #				Soldiers can be put in a transfer back to the base where they started if this parameter is greater than the default of 0 hours. New clones or resurrected soldiers are automatically given a transfer to the base with a default of 24 hours.
    recoveryTime: 3 #				The amount of wound recovery time a soldier is given after this project completes and the transfer, if any, is completed. The default value is 0 days.
    percentOverallStatChange: #			A percent change to the soldier's overall stats when undergoing this project, can be positive or negative - tu: 5 means the soldier will gain an extra 5% of their max time units, while tu: -5 means the soldier will lose 5% of their max time units. The default of 0 means no change.
      tu: -5
      stamina: -5
      health: -10
      bravery: -5
      reactions: -10
      firing: -10
      throwing: -10
      strength: -5
      psiStrength: 20
      psiSkill: 10
      melee: -20
    lowerBoundAtMinStats: true  #		Default true, this parameter determines whether or not any changes in stats from this project should go below the minStats defined on the new soldier type.
    upperBoundAtMaxStats: false #		Default false, this parameter determines whether or not any changes in stats from this project should go above the maxStats defined on the new soldier type.
    upperBoundAtStatCaps: false #		Default false, this parameter determines whether or not any changes in stats from this project should go above the statCaps defined on the new soldier type.
  - name: STR_SPECIALIST_MOLDING
    soldierBonusType: STR_SPECIALIST_INITIAL_BONUS
    keepSoldierArmor: false
    createsClone: false
    needsCorpseRecovered: false
    allowsDeadSoldiers: false 
    allowsLiveSoldiers: true
    minRank: 0 # squaddie
    allowedSoldierTypes:
      - STR_SPECIALIST
    requiredMinStats: #				The minimum stats a soldier must have in order to be eligible for this project, defaults to all 0 so any soldier is eligible
      tu: 45
      stamina: 45
      health: 0
      bravery: 50
      reactions: 0
      firing: 0
      throwing: 0
      strength: 0
      psiStrength: 0
      psiSkill: 0
      melee: 0
    cost: 50000      #				The cost of the project in dollars
    transferTime: 72 #				Soldiers can be put in a transfer back to the base where they started if this parameter is greater than the default of 0 hours. New clones or resurrected soldiers are automatically given a transfer to the base with a default of 24 hours.
    recoveryTime: 3 #				The amount of wound recovery time a soldier is given after this project completes and the transfer, if any, is completed. The default value is 0 days.
    percentOverallStatChange: #			A percent change to the soldier's overall stats when undergoing this project, can be positive or negative - tu: 5 means the soldier will gain an extra 5% of their max time units, while tu: -5 means the soldier will lose 5% of their max time units. The default of 0 means no change.
      tu: 10
      stamina: 10
      health: 0
      bravery: 20
      reactions: -10
      firing: -20
      throwing: -20
      strength: -5
      psiStrength: 0
      psiSkill: -100
      melee: -20
    lowerBoundAtMinStats: true  #		Default true, this parameter determines whether or not any changes in stats from this project should go below the minStats defined on the new soldier type.
    upperBoundAtMaxStats: false #		Default false, this parameter determines whether or not any changes in stats from this project should go above the maxStats defined on the new soldier type.
    upperBoundAtStatCaps: false #		Default false, this parameter determines whether or not any changes in stats from this project should go above the statCaps defined on the new soldier type.
  - name: STR_RANGER_ADVANCED_TRAINING
    forbiddenPreviousTransformations: [STR_RANGER_ADVANCED_TRAINING]
#    requiredCommendations:
#      STR_SOLDIER_EXPERIENCE: 1 # decoration level
    soldierBonusType: STR_RANGER_ADVANCED_BONUS
#    minRank: 2                # sergeant
    keepSoldierArmor: true
    createsClone: false
    needsCorpseRecovered: false
    allowsDeadSoldiers: false 
    allowsLiveSoldiers: true
    allowedSoldierTypes:
      - STR_RANGER
    cost: 50000               #				The cost of the project in dollars
    transferTime: 72          #				Soldiers can be put in a transfer back to the base where they started if this parameter is greater than the default of 0 hours. New clones or resurrected soldiers are automatically given a transfer to the base with a default of 24 hours.
    recoveryTime: 3           #				The amount of wound recovery time a soldier is given after this project completes and the transfer, if any, is completed. The default value is 0 days.
    percentOverallStatChange: #			  A percent change to the soldier's overall stats when undergoing this project, can be positive or negative - tu: 5 means the soldier will gain an extra 5% of their max time units, while tu: -5 means the soldier will lose 5% of their max time units. The default of 0 means no change.
      tu: 5
      stamina: 5
  - name: STR_GRENADIER_ADVANCED_TRAINING
    forbiddenPreviousTransformations: [STR_GRENADIER_ADVANCED_TRAINING]
#    requiredCommendations:
#      STR_SOLDIER_EXPERIENCE: 0 # decoration level 0
    soldierBonusType: STR_GRENADIER_ADVANCED_BONUS
#    minRank: 2                # sergeant
    keepSoldierArmor: true
    createsClone: false
    needsCorpseRecovered: false
    allowsDeadSoldiers: false 
    allowsLiveSoldiers: true
    allowedSoldierTypes:
      - STR_GRENADIER
    cost: 50000               #				The cost of the project in dollars
    transferTime: 72          #				Soldiers can be put in a transfer back to the base where they started if this parameter is greater than the default of 0 hours. New clones or resurrected soldiers are automatically given a transfer to the base with a default of 24 hours.
    recoveryTime: 3           #				The amount of wound recovery time a soldier is given after this project completes and the transfer, if any, is completed. The default value is 0 days.
    percentOverallStatChange: #			  A percent change to the soldier's overall stats when undergoing this project, can be positive or negative - tu: 5 means the soldier will gain an extra 5% of their max time units, while tu: -5 means the soldier will lose 5% of their max time units. The default of 0 means no change.
      health: 5
      strength: 5
  - name: STR_SNIPER_ADVANCED_TRAINING
    forbiddenPreviousTransformations: [STR_SNIPER_ADVANCED_TRAINING]
#    requiredCommendations:
#      STR_SOLDIER_EXPERIENCE: 0 # decoration level 0
    soldierBonusType: STR_SNIPER_ADVANCED_BONUS
#    minRank: 2                # sergeant
    keepSoldierArmor: true
    createsClone: false
    needsCorpseRecovered: false
    allowsDeadSoldiers: false 
    allowsLiveSoldiers: true
    allowedSoldierTypes:
      - STR_SNIPER
    cost: 50000               #				The cost of the project in dollars
    transferTime: 72          #				Soldiers can be put in a transfer back to the base where they started if this parameter is greater than the default of 0 hours. New clones or resurrected soldiers are automatically given a transfer to the base with a default of 24 hours.
    recoveryTime: 3           #				The amount of wound recovery time a soldier is given after this project completes and the transfer, if any, is completed. The default value is 0 days.
    percentOverallStatChange: #			  A percent change to the soldier's overall stats when undergoing this project, can be positive or negative - tu: 5 means the soldier will gain an extra 5% of their max time units, while tu: -5 means the soldier will lose 5% of their max time units. The default of 0 means no change.
      firing: 5
  - name: STR_SPECIALIST_ADVANCED_TRAINING
    forbiddenPreviousTransformations: [STR_SPECIALIST_ADVANCED_TRAINING]
#    requiredCommendations:
#      STR_SOLDIER_EXPERIENCE: 0 # decoration level 0
    soldierBonusType: STR_SPECIALIST_ADVANCED_BONUS
#    minRank: 2                # sergeant
    keepSoldierArmor: true
    createsClone: false
    needsCorpseRecovered: false
    allowsDeadSoldiers: false 
    allowsLiveSoldiers: true
    allowedSoldierTypes:
      - STR_SPECIALIST
    cost: 50000               #				The cost of the project in dollars
    transferTime: 72          #				Soldiers can be put in a transfer back to the base where they started if this parameter is greater than the default of 0 hours. New clones or resurrected soldiers are automatically given a transfer to the base with a default of 24 hours.
    recoveryTime: 3           #				The amount of wound recovery time a soldier is given after this project completes and the transfer, if any, is completed. The default value is 0 days.
    percentOverallStatChange: #			  A percent change to the soldier's overall stats when undergoing this project, can be positive or negative - tu: 5 means the soldier will gain an extra 5% of their max time units, while tu: -5 means the soldier will lose 5% of their max time units. The default of 0 means no change.
      bravery: 5
      stamina: 5
  - name: STR_RANGER_ELITE_TRAINING
    requiredPreviousTransformations:
      - STR_RANGER_ADVANCED_TRAINING
    forbiddenPreviousTransformations: [STR_RANGER_ELITE_TRAINING]
#    requiredCommendations:
#      STR_SOLDIER_EXPERIENCE: 3 # decoration level
    soldierBonusType: STR_RANGER_ELITE_BONUS
#    minRank: 3                # captain
    keepSoldierArmor: true
    createsClone: false
    needsCorpseRecovered: false
    allowsDeadSoldiers: false 
    allowsLiveSoldiers: true
    allowedSoldierTypes:
      - STR_RANGER
    cost: 50000               #				The cost of the project in dollars
    transferTime: 72          #				Soldiers can be put in a transfer back to the base where they started if this parameter is greater than the default of 0 hours. New clones or resurrected soldiers are automatically given a transfer to the base with a default of 24 hours.
    recoveryTime: 3           #				The amount of wound recovery time a soldier is given after this project completes and the transfer, if any, is completed. The default value is 0 days.
    percentOverallStatChange: #			  A percent change to the soldier's overall stats when undergoing this project, can be positive or negative - tu: 5 means the soldier will gain an extra 5% of their max time units, while tu: -5 means the soldier will lose 5% of their max time units. The default of 0 means no change.
      tu: 5
      stamina: 5
  - name: STR_GRENADIER_ELITE_TRAINING
    requiredPreviousTransformations:
      - STR_GRENADIER_ADVANCED_TRAINING
    forbiddenPreviousTransformations: [STR_GRENADIER_ELITE_TRAINING]
#    requiredCommendations:
#      STR_SOLDIER_EXPERIENCE: 2 # decoration level
    soldierBonusType: STR_GRENADIER_ELITE_BONUS
#    minRank: 3                # captain
    keepSoldierArmor: true
    createsClone: false
    needsCorpseRecovered: false
    allowsDeadSoldiers: false 
    allowsLiveSoldiers: true
    allowedSoldierTypes:
      - STR_GRENADIER
    cost: 50000               #				The cost of the project in dollars
    transferTime: 72          #				Soldiers can be put in a transfer back to the base where they started if this parameter is greater than the default of 0 hours. New clones or resurrected soldiers are automatically given a transfer to the base with a default of 24 hours.
    recoveryTime: 3           #				The amount of wound recovery time a soldier is given after this project completes and the transfer, if any, is completed. The default value is 0 days.
    percentOverallStatChange: #			  A percent change to the soldier's overall stats when undergoing this project, can be positive or negative - tu: 5 means the soldier will gain an extra 5% of their max time units, while tu: -5 means the soldier will lose 5% of their max time units. The default of 0 means no change.
      health: 5
      strength: 5
  - name: STR_SNIPER_ELITE_TRAINING
    requiredPreviousTransformations:
      - STR_SNIPER_ADVANCED_TRAINING
    forbiddenPreviousTransformations: [STR_SNIPER_ELITE_TRAINING]
#    requiredCommendations:
#      STR_SOLDIER_EXPERIENCE: 2 # decoration level 
    soldierBonusType: STR_SNIPER_ELITE_BONUS
#    minRank: 3                # captain
    keepSoldierArmor: true
    createsClone: false
    needsCorpseRecovered: false
    allowsDeadSoldiers: false 
    allowsLiveSoldiers: true
    allowedSoldierTypes:
      - STR_SNIPER
    cost: 50000               #				The cost of the project in dollars
    transferTime: 72          #				Soldiers can be put in a transfer back to the base where they started if this parameter is greater than the default of 0 hours. New clones or resurrected soldiers are automatically given a transfer to the base with a default of 24 hours.
    recoveryTime: 3           #				The amount of wound recovery time a soldier is given after this project completes and the transfer, if any, is completed. The default value is 0 days.
    percentOverallStatChange: #			  A percent change to the soldier's overall stats when undergoing this project, can be positive or negative - tu: 5 means the soldier will gain an extra 5% of their max time units, while tu: -5 means the soldier will lose 5% of their max time units. The default of 0 means no change.
      firing: 5
  - name: STR_SPECIALIST_ELITE_TRAINING
    requiredPreviousTransformations:
      - STR_SPECIALIST_ADVANCED_TRAINING
    forbiddenPreviousTransformations: [STR_SPECIALIST_ELITE_TRAINING]
#    requiredCommendations:
#      STR_SOLDIER_EXPERIENCE: 2 # decoration level 
    soldierBonusType: STR_SPECIALIST_ELITE_BONUS
#    minRank: 3                # captain
    keepSoldierArmor: true
    createsClone: false
    needsCorpseRecovered: false
    allowsDeadSoldiers: false 
    allowsLiveSoldiers: true
    allowedSoldierTypes:
      - STR_SPECIALIST
    cost: 50000               #				The cost of the project in dollars
    transferTime: 72          #				Soldiers can be put in a transfer back to the base where they started if this parameter is greater than the default of 0 hours. New clones or resurrected soldiers are automatically given a transfer to the base with a default of 24 hours.
    recoveryTime: 3           #				The amount of wound recovery time a soldier is given after this project completes and the transfer, if any, is completed. The default value is 0 days.
    percentOverallStatChange: #			  A percent change to the soldier's overall stats when undergoing this project, can be positive or negative - tu: 5 means the soldier will gain an extra 5% of their max time units, while tu: -5 means the soldier will lose 5% of their max time units. The default of 0 means no change.
      bravery: 5
      stamina: 5

# targeting modes:
# 0   = No target needed (Just activation, script takes over) - BA_NONE
#       Default Action: no-op
# 10  = Melee Range Targeted (1 Tile) - BA_HIT
#       Default Action: Melee with equipped weapon, weapon overridable
# mul = Firearm (Default firarm targeting) - SNAP = 8, AUTO = 7, AIMED = 9
#       Default Action: Snapshot with equipped weapon, weapon overridable
# mul = Psi Targeting (Default PSI Targeting, with or without LOS) - BA_USE = 11, BA_MINDCONTROL = 13, BA_PANIC = 14
#       Default Action: Use action with equipped Psi Amp, weapon overridable
# 6   = Thrown Targeting (Default Thrown targeting, uses throwing arc) - BA_THROW
#       Default Action: Throw equipped throwable item, weapon overridable
# 12  = Waypoint Targeting (Default blaster launcher targeting) - BA_LAUNCH
#       Default Action: Launch with equipped weapon, weapon overridable

skills:
  - type: STR_RUN_AND_GUN
    scriptId: 10
    requiredBonus: [STR_RANGER_INITIAL_BONUS]
    costUse:
      time: 0
      mana: 12
    flatUse:
      mana: true
  - type: STR_SLASH
    scriptId: 11
    requiredBonus: [STR_RANGER_INITIAL_BONUS]
    costUse:
      time: 0
      mana: 6
    flatUse:
      mana: true
    targetMode: 10
    compatibleWeapons: [STR_STUN_ROD, STR_ALLOY_SWORD]
  - type: STR_CONCEAL
    scriptId: 12
    requiredBonus: [STR_RANGER_ADVANCED_BONUS]
    costUse:
      time: 5
      mana: 12
    flatUse:
      mana: true
      time: true
  - type: STR_RAPID_FIRE
    scriptId: 13
    requiredBonus: [STR_RANGER_ADVANCED_BONUS]
    costUse:
      time: 50
      mana: 5
    flatUse:
      mana: true
      time: false
    targetMode: 7 # auto
    compatibleWeapons: [STR_SHOTGUN, STR_ALLOY_SHOTGUN]
  - type: STR_REAPER
    scriptId: 14
    requiredBonus: [STR_RANGER_ELITE_BONUS]
    costUse:
      time: 0
      mana: 12
    flatUse:
      mana: true
  - type: STR_HEAVY_ROCKET
    scriptId: 20
    requiredBonus: [STR_GRENADIER_INITIAL_BONUS]
    costUse:
      time: 20
      mana: 12
    flatUse:
      mana: true
      time: true
    compatibleWeapons: [STR_HEAVY_ROCKET_SKILL]
    checkHandsOnly: false
    targetMode: 8 # snap
  - type: STR_RAPID_DEPLOYMENT
    scriptId: 21
    requiredBonus: [STR_GRENADIER_INITIAL_BONUS]
    costUse:
      time: 5
      mana: 5
    flatUse:
      mana: true
      time: true
    targetMode: 6 # throw
    checkHandsOnly: false
    compatibleWeapons: [STR_GRENADE]
  - type: STR_WAR_CRY
    scriptId: 22
    requiredBonus: [STR_GRENADIER_ADVANCED_BONUS]
    costUse:
      time: 10
      mana: 8
    flatUse:
      mana: true
      time: true
  - type: STR_RAGE_BURST
    scriptId: 23
    requiredBonus: [STR_GRENADIER_ADVANCED_BONUS]
    costUse:
      time: 50
      mana: 12
    flatUse:
      mana: true
      time: false
    flatUse:
      time: false
    targetMode: 7 # auto
    compatibleWeapons: [STR_LMG]
  - type: STR_RUPTURE
    scriptId: 24
    requiredBonus: [STR_GRENADIER_ELITE_BONUS]
    costUse:
      time: 0
      mana: 12
    flatUse:
      mana: true
  - type: STR_HEADSHOT       # default, increased crit chance + crit damage
    scriptId: 30
    requiredBonus: [STR_SNIPER_INITIAL_BONUS]
    costUse:
      time: 85
      mana: 4
    flatUse:
      mana: true
      time: false
    targetMode: 8 # snap
    compatibleWeapons: [STR_SNIPER_RIFLE, STR_LASER_SNIPER_RIFLE]
  - type: STR_DISABLING_SHOT  # default, no damage, disable weapon of target
    scriptId: 31
    requiredBonus: [STR_SNIPER_INITIAL_BONUS]
    costUse:
      time: 85
      mana: 4
    flatUse:
      mana: true
      time: false
    targetMode: 8 # snap
    compatibleWeapons: [STR_SNIPER_RIFLE, STR_LASER_SNIPER_RIFLE]
  - type: STR_QUICK_AIM     # X reduce cost / increase aim
    scriptId: 32
    requiredBonus: [STR_SNIPER_ADVANCED_BONUS]
    costUse:
      time: 50
      mana: 6
    flatUse:
      mana: true
      time: false
    targetMode: 9 # aimed
    compatibleWeapons: [STR_SNIPER_RIFLE, STR_LASER_SNIPER_RIFLE]
  - type: STR_DOUBLE_TAP     # X default, fire two shots
    scriptId: 33
    requiredBonus: [STR_SNIPER_ADVANCED_BONUS]
    costUse:
      time: 85
      mana: 8
    flatUse:
      mana: true
      time: false
    targetMode: 7 # auto
    compatibleWeapons: [STR_SNIPER_RIFLE, STR_LASER_SNIPER_RIFLE]
  - type: STR_SERIAL
    scriptId: 34
    requiredBonus: [STR_SNIPER_ELITE_BONUS]
    costUse:
      time: 0
      mana: 12
    flatUse:
      mana: true
  - type: STR_PARAMEDIC
    scriptId: 40
    requiredBonus: [STR_SPECIALIST_INITIAL_BONUS]
    costUse:
      time: 2
      mana: 2
    flatUse:
      mana: true
      time: true
    targetMode: 11 # use
    checkHandsOnly: false
    compatibleWeapons: [STR_MEDI_KIT]
  - type: STR_AID_PROTOCOL
    scriptId: 41
    requiredBonus: [STR_SPECIALIST_INITIAL_BONUS]
    costUse:
      time: 50
      mana: 6
    flatUse:
      mana: true
      time: false
    targetMode: 11 # use
    checkHandsOnly: false
    compatibleWeapons: [STR_SKILL_AMP_FRIENDLY_ONLY]
  - type: STR_COMBAT_PROTOCOL
    scriptId: 42
    requiredBonus: [STR_SPECIALIST_ADVANCED_BONUS]
    costUse:
      time: 50
      mana: 6
    flatUse:
      mana: true
      time: false
    targetMode: 11 # use
    checkHandsOnly: false
    compatibleWeapons: [STR_SKILL_AMP_FRIENDLY_ONLY]
  - type: STR_INTERFERENCE
    scriptId: 43
    requiredBonus: [STR_SPECIALIST_ADVANCED_BONUS]
    costUse:
      time: 50
      mana: 8
    flatUse:
      mana: true
      time: false
    targetMode: 11 # use
    checkHandsOnly: false
    compatibleWeapons: [STR_SKILL_AMP_FRIENDLY_ONLY]
  - type: STR_RESTORATION
    scriptId: 44
    requiredBonus: [STR_SPECIALIST_ELITE_BONUS]
    costUse:
      time: 55
      mana: 12
    flatUse:
      mana: true
      time: false

soldiers:
  - type: STR_RANGER
    showTypeInInventory: true
    tags:
      CLASS: 1
    skillIconSprite: 2
    skills:
      - STR_RUN_AND_GUN
      - STR_SLASH
      - STR_CONCEAL
      - STR_RAPID_FIRE
      - STR_REAPER
    costBuy: 50000
    costSalary: 50000
    value: 30
    minStats:
      tu: 40
      stamina: 60
      health: 25
      bravery: 50
      reactions: 50
      firing: 20
      throwing: 20
      strength: 30
      psiStrength: 50
      psiSkill: 0
      melee: 40
      mana: 12
    maxStats:
      tu: 70
      stamina: 80
      health: 40
      bravery: 70
      reactions: 70
      firing: 70
      throwing: 80
      strength: 50
      psiStrength: 100
      psiSkill: 0
      melee: 80
      mana: 12
    statCaps:
      tu: 100
      stamina: 100
      health: 50
      bravery: 100
      reactions: 100
      firing: 100
      throwing: 100
      strength: 90
      psiStrength: 100
      psiSkill: 60
      melee: 120
      mana: 12
    standHeight: 22
    kneelHeight: 14
    femaleFrequency: 50
    allowPromotion: true
    nameInTitles: "{NAME}"
    nameInTitlesLong: "{NAME} aka {CALLSIGN}"
    nameInLists: "{NAME}"
    nameInListsLong: "{NAME}{STATSTRING}"
    nameInPilotLists: "{NAME}"
    nameInBattleScape: "{CALLSIGN}{TAGSTRING}"
    nameInBattleScapeAlternate: "{NAME}{STATSTRING}"
    nameStatStringSeparator: "/"
    nameTagStatStringSeparator: ">"
    soldierNames:               # extended *.nam file format allows for male & female callsigns
      - delete
      - RangerNames/
    deathMale: [41, 42, 43]
    deathFemale: [44, 45, 46]
    rankStrings:
      - STR_ROOKIE_RANGER_RANK
      - STR_SQUADDIE_RANGER_RANK
      - STR_SERGEANT_RANGER_RANK
      - STR_CAPTAIN_RANGER_RANK
      - STR_COLONEL_RANGER_RANK
      - STR_COMMANDER_RANGER_RANK
    armor: STR_NONE_UC
  - type: STR_GRENADIER
    showTypeInInventory: true
    tags:
      CLASS: 2
    specialWeapon: STR_HEAVY_ROCKET_SKILL
    skillIconSprite: 3
    skills:
      - STR_HEAVY_ROCKET
      - STR_RAPID_DEPLOYMENT
      - STR_SHREDDER_ROCKET
      - STR_RAGE_BURST
      - STR_RUPTURE
    costBuy: 50000
    costSalary: 50000
    value: 30
    minStats:
      tu: 30
      stamina: 60
      health: 45
      bravery: 50
      reactions: 0
      firing: 20
      throwing: 20
      strength: 40
      psiStrength: 40
      psiSkill: 0
      melee: 10
      mana: 12
    maxStats:
      tu: 40
      stamina: 70
      health: 55
      bravery: 70
      reactions: 10
      firing: 40
      throwing: 80
      strength: 60
      psiStrength: 100
      psiSkill: 0
      melee: 40
      mana: 12
    statCaps:
      tu: 65
      stamina: 100
      health: 80
      bravery: 100
      reactions: 50
      firing: 70
      throwing: 70
      strength: 110
      psiStrength: 100
      psiSkill: 50
      melee: 60
      mana: 12
    standHeight: 22
    kneelHeight: 14
    femaleFrequency: 50
    allowPromotion: true
    nameInTitles: "{NAME}"
    nameInTitlesLong: "{NAME} aka {CALLSIGN}"
    nameInLists: "{NAME}"
    nameInListsLong: "{NAME}{STATSTRING}"
    nameInPilotLists: "{NAME}"
    nameInBattleScape: "{CALLSIGN}{TAGSTRING}"
    nameInBattleScapeAlternate: "{NAME}{STATSTRING}"
    nameStatStringSeparator: "/"
    nameTagStatStringSeparator: ">"
    soldierNames:               # extended *.nam file format allows for male & female callsigns
      - delete
      - GrenadierNames/
    deathMale: [41, 42, 43]
    deathFemale: [44, 45, 46]
    rankStrings:
      - STR_ROOKIE_GRENADIER_RANK
      - STR_SQUADDIE_GRENADIER_RANK
      - STR_SERGEANT_GRENADIER_RANK
      - STR_CAPTAIN_GRENADIER_RANK
      - STR_COLONEL_GRENADIER_RANK
      - STR_COMMANDER_GRENADIER_RANK
    armor: STR_NONE_UC
  - type: STR_SNIPER
    showTypeInInventory: true
    tags:
      CLASS: 3
    skillIconSprite: 4
    skills:
      - STR_HEADSHOT       # default, increased crit chance + crit damage
      - STR_DISABLING_SHOT  # default, no damage, disable weapon of target
      - STR_QUICK_AIM     # X reduce cost / increase aim
      - STR_DOUBLE_TAP     # X default, fire two shots
      - STR_SERIAL
    costBuy: 50000
    costSalary: 50000
    value: 30
    minStats:
      tu: 50
      stamina: 50
      health: 20
      bravery: 30
      reactions: 50
      firing: 70
      throwing: 20
      strength: 10
      psiStrength: 50
      psiSkill: 0
      melee: 0
      mana: 12
    maxStats:
      tu: 70
      stamina: 70
      health: 35
      bravery: 50
      reactions: 70
      firing: 80
      throwing: 80
      strength: 30
      psiStrength: 100
      psiSkill: 0
      melee: 10
      mana: 12
    statCaps:
      tu: 80
      stamina: 100
      health: 45
      bravery: 100
      reactions: 100
      firing: 150
      throwing: 120
      strength: 50
      psiStrength: 100
      psiSkill: 60
      melee: 20
      mana: 12
    standHeight: 22
    kneelHeight: 14
    femaleFrequency: 50
    allowPromotion: true
    soldierNames:               # extended *.nam file format allows for male & female callsigns
      - delete
      - SniperNames/
    deathMale: [41, 42, 43]
    deathFemale: [44, 45, 46]
    rankStrings:
      - STR_ROOKIE_SNIPER_RANK
      - STR_SQUADDIE_SNIPER_RANK
      - STR_SERGEANT_SNIPER_RANK
      - STR_CAPTAIN_SNIPER_RANK
      - STR_COLONEL_SNIPER_RANK
      - STR_COMMANDER_SNIPER_RANK
    armor: STR_NONE_UC
  - type: STR_SPECIALIST
    showTypeInInventory: true
    tags:
      CLASS: 4
    specialWeapon: STR_SKILL_AMP_FRIENDLY_ONLY
    skillIconSprite: 5
    skills:
      - STR_PARAMEDIC
      - STR_AID_PROTOCOL
      - STR_COMBAT_PROTOCOL
      - STR_INTERFERENCE
      - STR_RESTORATION
    costBuy: 50000
    costSalary: 50000
    value: 30
    minStats:
      tu: 45
      stamina: 45
      health: 25
      bravery: 50
      reactions: 0
      firing: 0
      throwing: 0
      strength: 20
      psiStrength: 50
      psiSkill: 0
      melee: 0
      mana: 12
    maxStats:
      tu: 80
      stamina: 80
      health: 40
      bravery: 80
      reactions: 40
      firing: 40
      throwing: 40
      strength: 50
      psiStrength: 100
      psiSkill: 0
      melee: 20
      mana: 12
    statCaps:
      tu: 100
      stamina: 100
      health: 50
      bravery: 120
      reactions: 70
      firing: 60
      throwing: 60
      strength: 70
      psiStrength: 100
      psiSkill: 60
      melee: 70
      mana: 12
    standHeight: 22
    kneelHeight: 14
    femaleFrequency: 50
    allowPromotion: true
    soldierNames:               # extended *.nam file format allows for male & female callsigns
      - delete
      - SpecialistNames/
    deathMale: [41, 42, 43]
    deathFemale: [44, 45, 46]
    rankStrings:
      - STR_ROOKIE_SPECIALIST_RANK
      - STR_SQUADDIE_SPECIALIST_RANK
      - STR_SERGEANT_SPECIALIST_RANK
      - STR_CAPTAIN_SPECIALIST_RANK
      - STR_COLONEL_SPECIALIST_RANK
      - STR_COMMANDER_SPECIALIST_RANK
    armor: STR_NONE_UC
  - type: STR_PSI_OPERATIVE
    showTypeInInventory: true
    skillIconSprite: 6
    tags:
      CLASS: 5
    costBuy: 0
    costSalary: 50000
    value: 30
    minStats:
      tu: 45
      stamina: 40
      health: 20
      bravery: 30
      reactions: 20
      firing: 20
      throwing: 20
      strength: 10
      psiStrength: 70
      psiSkill: 16
      melee: 0
      mana: 12
    maxStats:
      tu: 65
      stamina: 70
      health: 35
      bravery: 50
      reactions: 50
      firing: 40
      throwing: 40
      strength: 30
      psiStrength: 100
      psiSkill: 50
      melee: 10
      mana: 12
    statCaps:
      tu: 80
      stamina: 100
      health: 45
      bravery: 100
      reactions: 100
      firing: 150
      throwing: 120
      strength: 50
      psiStrength: 100
      psiSkill: 60
      melee: 20
      mana: 12
    standHeight: 22
    kneelHeight: 14
    femaleFrequency: 50
    allowPromotion: true
    soldierNames:               # extended *.nam file format allows for male & female callsigns
      - delete
      - PsiOpNames/
    deathMale: [41, 42, 43]
    deathFemale: [44, 45, 46]
    rankStrings:
      - STR_ROOKIE_PSI_OPERATIVE_RANK
      - STR_SQUADDIE_PSI_OPERATIVE_RANK
      - STR_SERGEANT_PSI_OPERATIVE_RANK
      - STR_CAPTAIN_PSI_OPERATIVE_RANK
      - STR_COLONEL_PSI_OPERATIVE_RANK
      - STR_COMMANDER_PSI_OPERATIVE_RANK
    armor: STR_NONE_UC

extended:
  tags:
    RuleArmor:
      SKILL_POWER_ARMOR: int
    RuleSoldier:
      CLASS: int            # 0 = no class, 1 = Ranger, 2 = Grenadier, 3 = Sniper, 4 = Specialist, 5 = Psi
    BattleGame:
      TURN_SIDE: int
      BATTLE_CRY_STATE: int # 0 = not activated, 1 = active this turn, 2 = disabled
      BATTLE_CRY_X: int     # x position where battle cry was activated
      BATTLE_CRY_Y: int     # y position where battle cry was activated
    BattleUnit:
      LIGHTNING_REFLEXES_STATE: int
      UNTOUCHABLE_COUNTER: int
      UNTOUCHABLE_STATE: int
      REAPER_STATE: int  # 0 = not available, 1 = not activated yet, available 2 = active in this turn
      DEATH_FROM_ABOVE_STATE: int
      BLAST_PADDING_STATE: int
      PHANTOM_STATE: int
      PHANTOM_STATE_ORIGINAL: int
      STASIS_STATE: int  # 0 = no stasis, 1 = stasis active until next alien turn, 2 = stasis active until next xcom turn
      SUSTAIN_STATE: int
      EXECUTIONER_STATE: int
      THREAT_ASSESSMENT_STATE: int
      BACKSTAB_STATE: int
      BLADEMASTER_STATE: int
      FIELD_SPECIALIST_STATE: int
      RUPTURE_STATE: int # 0 = no effect, 1 = active on next hit, 2 = unit is ruptured (takes increased damage)
      SHREDDER_STATE: int
      PARRY_STATE: int
      MELEE_DEFENSE_STATE: int
      SLAYER_STATE: int
      RUN_AND_GUN_STATE: int
      HEADSHOT_STATE: int
      SHADOWSTRIKE_STATE: int
      AIM_STATE: int
      ALPHA_MIKE_FOXTROT_STATE: int
      SERIAL_STATE: int
      SAVIOR_STATE: int
      MAYHEM_STATE: int
      STEADFAST_STATE: int
      EVER_VIGILANT_STATE: int
      GUARDIAN_STATE: int
      STING_GRENADES_STATE: int
      CENTER_MASS_STATE: int
      FIELD_SURGEON_STATE: int
      BATTLE_CRY_ACTIVATED: int
      HEALED_BY_FIELD_SURGEON: int
      STUNNED: int
      AIM_X: int
      AIM_Y: int
      AIM_Z: int
      WEAPON_DISABLED: int
    RuleSoldierBonus:
      LIGHTNING_REFLEXES: int
      UNTOUCHABLE: int
      REAPER: int
      DEATH_FROM_ABOVE: int
      BLAST_PADDING: int
      PHANTOM: int
      SUSTAIN: int
      EXECUTIONER: int
      THREAT_ASSESSMENT: int
      BACKSTAB: int
      BLADEMASTER: int
      FIELD_SPECIALIST: int
      RUN_AND_GUN: int
      PHANTOM: int
      SHADOWSTRIKE: int
      SHREDDER: int
      RAPID_DEPLOYMENT: int
      MAYHEM: int
      STING_GRENADES: int
      RUPTURE: int
      HEADSHOT: int
      AIM: int
      CENTER_MASS: int
      ALPHA_MIKE_FOXTROT: int
      SERIAL: int
      AID_PROTOCOL: int
      STEADFAST: int
      REVIVE: int
      SAVIOR: int
      RESTORATION: int
      HEAVY_ROCKET: int
      PARAMEDIC: int
      GUARDIAN: int
      FIELD_SURGEON: int
      EVER_VIGILANT: int
    RuleItem:
      SKILL_POWER_ITEM: int
      CLASS_SKILL_ACTIVATION: int
      SWORD_TYPE: int
      GUN_TYPE: int
      RUPTURE_DAMAGE: int
      SHREDDER_DAMAGE: int
  scripts:
    skillUseUnit:
      - offset: 23
        code: |
          var int unit_class;
          var int temp;
          var ptr RuleItem item_rule;
          var ptr RuleSoldier soldier_rule;
          var ptr RuleArmor armor_rule;
          var int run_and_gun;
          var int max;
          var int cur;
          var int result;

          debug_log "SkillUse triggered" have_tu;

          if eq have_tu 0;
            debug_log "No Resources. Aborted.";
            set continue_action 0;
            return;
          end;

          if eq skill_id 10;    # Run & Gun
            debug_log "Skill activation (Run & Gun)";

            actor.getTimeUnitsMax max;
            actor.getTimeUnits cur;
            add cur max;
            actor.setTimeUnits cur;

            actor.getEnergyMax max;
            actor.getEnergy cur;
            add cur max;
            actor.setEnergy cur;

            set spend_tu 1; # spend the mana for skill use
          else eq skill_id 12;    # Conceal
            debug_log "Skill activation (Conceal)";
            battle_game.tryConcealUnit actor result;
            if gt result 0;
              actor.getTag temp Tag.PHANTOM_STATE_ORIGINAL;
              actor.setTag Tag.PHANTOM_STATE temp;
              set spend_tu 1;
            else;
              battle_game.flashMessage "Failed. You have been spotted.";
            end;
          else eq skill_id 14;    # Reaper
            actor.getTag temp Tag.REAPER_STATE;
            if eq temp 1; # not yet activated in this mission, activate now
              battle_game.flashMessage "REAPER Activated";
              actor.setTag Tag.REAPER_STATE 2;
              set spend_tu 1;
            end;
          else eq skill_id 22;    # War Cry
            actor.setTag Tag.BATTLE_CRY_ACTIVATED 1;
            battle_game.setTag Tag.BATTLE_CRY_STATE 1;
            actor.getPosition.getX temp;
            battle_game.setTag Tag.BATTLE_CRY_X temp;
            actor.getPosition.getY temp;
            battle_game.setTag Tag.BATTLE_CRY_Y temp;
            battle_game.flashMessage "WAR CRY Activated";
            set spend_tu 1;
          else eq skill_id 24;    # Rupture
            battle_game.flashMessage "RUPTURE Activated";
            actor.setTag Tag.RUPTURE_STATE 1;
            set spend_tu 1;
          else eq skill_id 34;    # Serial
            actor.getTag temp Tag.SERIAL_STATE;
            if eq temp 1; # not yet activated in this mission, activate now
              battle_game.flashMessage "SERIAL Activated";
              actor.setTag Tag.SERIAL_STATE 2;
              set spend_tu 1;
            end;
          else eq skill_id 44;    # Restoration
            battle_game.flashMessage "RESTORATION Activated";
            # TODO: add effect
            set spend_tu 1;
          end;
          #debug_log " - for Sniper (Headshot)";
          #actor.setTag Tag.CRIT_CHANCE_NEXT_HIT 30; # increase hit chance by 30% for next hit
          #actor.setTag Tag.CRIT_DAMAGE_NEXT_HIT 20; # increase hit damage by 20% for next hit
          return;
    reactionUnitAction: 
      - offset: 23   # for lightning reflexes
        code: |
          var int reflexes;
          var int action_id;
          var int reaction_id;

          action_unit.getId action_id;
          reaction_unit.getId reaction_id;

          action_unit.getTag reflexes Tag.LIGHTNING_REFLEXES_STATE;
          
          if gt reflexes 0;
            debug_log "Reaction chance before LR activation:" reaction_chance;
            set reaction_chance 100;
            sub reaction_chance reflexes;
            debug_log "Lightning Reflexes Activated! RC now:" reaction_chance;
          end;
          return reaction_chance;
    newTurnUnit:
      - offset: 23   # Essentials (Store the turn side in the battle game at the beginning of each turn)
        code: |
          battle_game.setTag Tag.TURN_SIDE side;
          return;
      - offset: 24   # for phantom
        code: |
          var int turns_since_spotted;
          var int phantom;

          unit.getTurnsSinceSpotted turns_since_spotted;
          
          if and neq turns_since_spotted 255 gt turns_since_spotted -1;
            unit.getTag phantom Tag.PHANTOM_STATE;
            if gt phantom 0;
              unit.setTag Tag.PHANTOM_STATE 0;
              debug_log "You have been spotted! Concealmeant disabled.";
            end;
          end;
          return;
      - offset: 25   # for untouchable
        code: |
          var int untouchable;
          var int unit_id;
          var int counter;

          if eq side 0; # xcom turns
            unit.getId unit_id;
            
            unit.getTag untouchable Tag.UNTOUCHABLE_STATE;

            if gt untouchable 0;
              debug_log "New turn for untouchable unit:" unit_id;
              unit.getTag counter Tag.UNTOUCHABLE_COUNTER;
              if gt counter 0;
                debug_log "Untouchable reset!";
                unit.setTag Tag.UNTOUCHABLE_COUNTER 0;
              end;
            end;
          end;
          return;
      - offset: 26   # for reaper
        code: |
          var int reaper_state;
          var int unit_id;
          if eq side 0; # xcom turns
            unit.getId unit_id;
            unit.getTag reaper_state Tag.REAPER_STATE;

            if gt reaper_state 1;
              debug_log "Reaper was active last turn for:" unit_id;
              debug_log "Reaper deactivated for this unit.";
              unit.setTag Tag.REAPER_STATE 0;
            end;
          end;
          return;
      - offset: 27   # for stasis
        code: |
          var int stasis_state;
          var int unit_id;

          unit.getTag stasis_state Tag.STASIS_STATE;

          if and eq stasis_state 1 eq side 1; # end on alien turn
            unit.getId unit_id;
            debug_log "Stasis was active last turn for:" unit_id;
            debug_log "Stasis deactivated for this unit.";
            unit.setTag Tag.STASIS_STATE 0;
          else and eq stasis_state 2 eq side 0; # end on xcom turn
            unit.getId unit_id;
            debug_log "Stasis was active last turn for:" unit_id;
            debug_log "Stasis deactivated for this unit.";
            unit.setTag Tag.STASIS_STATE 0;
          end;
          return;
      - offset: 28   # for war cry
        code: |
          var int battle_cry;
          var int activation_dist_sq;
          var int temp;
          var int two_dee_distance_sq;
          var int source_x;
          var int source_y;
          var int unit_x;
          var int unit_y;

          set activation_dist_sq 7;

          if eq side 0; # on x-com turn
            unit.getTag temp Tag.BATTLE_CRY_ACTIVATED;
            if gt temp 0;
              # this unit has activated battle cry
              sub temp 1;
              battle_game.setTag Tag.BATTLE_CRY_STATE temp;
              unit.setTag Tag.BATTLE_CRY_ACTIVATED temp;
              debug_log "Reduced battle cry counter..";
            end;
          end;

          battle_game.getTag battle_cry Tag.BATTLE_CRY_STATE;

          if eq battle_cry 1;
            set two_dee_distance_sq 0;
            mul activation_dist_sq activation_dist_sq;

            battle_game.getTag source_x Tag.BATTLE_CRY_X;
            battle_game.getTag source_y Tag.BATTLE_CRY_Y;

            unit.getPosition.getX unit_x;
            unit.getPosition.getY unit_y;
            
            sub source_x unit_x;
            sub source_y unit_y;

            mul source_x source_x;
            mul source_y source_y;

            add two_dee_distance_sq source_x;
            add two_dee_distance_sq source_y;
            
            debug_log "Battle cry distance (sq)" activation_dist_sq;
            debug_log "Unit dist from source (sq)" two_dee_distance_sq;

            if gt two_dee_distance_sq activation_dist_sq;
              debug_log "Too far away. No effect.";
            else;
              debug_log "Unit is under effect of battle cry!";
              unit.getEnergyMax temp;
              unit.setEnergy temp;

              unit.getTimeUnits temp;
              add temp 16;
              unit.setTimeUnits temp;

              unit.getMorale temp;
              add temp 20;
              unit.setMorale temp;
            end;
          end;

          return;
      - offset: 29   # for stun / sting grenades
        code: |
          var int stunned;
          if eq side 0; # xcom turns
            unit.getTag stunned Tag.STUNNED;
            if gt stunned 0;
              sub stunned 1;
              unit.setTag Tag.STUNNED stunned;            
              unit.setTimeUnits 0;
              debug_log unit "is still stunned.";
            end;
          end;
          return;
      - offset: 30   # for death from above
        code: |
          var int death_from_above;
          if eq side 0; # xcom turns
            unit.getTag death_from_above Tag.DEATH_FROM_ABOVE_STATE;
            if eq death_from_above 2;
              unit.setTag Tag.DEATH_FROM_ABOVE_STATE 1;
              debug_log unit " - Death from above reset.";
            end;
          end;
          return;
      - offset: 31   # for aim
        code: |
          var int is_kneeling;
          var int pos_x;
          var int pos_y;
          var int pos_z;
          var int aim;
          var int kneeling;
          if eq side 0; # xcom turns
            unit.getTag aim Tag.AIM_STATE;
            unit.isKneeled kneeling;

            if and gt aim 0 gt kneeling 0;
              unit.getPosition.getX pos_x;
              unit.getPosition.getY pos_y;
              unit.getPosition.getZ pos_z;

              unit.setTag Tag.AIM_STATE 2; # was kneeling at the beginning of the turn
              
              unit.setTag Tag.AIM_X pos_x;
              unit.setTag Tag.AIM_Y pos_y;
              unit.setTag Tag.AIM_Z pos_z;
            end;
          end;
          return;
      - offset: 32   # for ever vigilant
        code: |
          var int vigilant;
          var int tu_max;
          unit.getTag vigilant Tag.EVER_VIGILANT_STATE;
          
          if and eq side 1 gt vigilant 0; # ever vigilant only triggers on enemy turns
            debug_log unit " - Ever vigilant activated. All TU refunded for beginng of enemy turn.";
            unit.getTimeUnitsMax tu_max;
            unit.setTimeUnits tu_max;
          end;
          return;
      - offset: 33   # for serial
        code: |
          var int serial_state;
          var int unit_id;
          if eq side 0; # xcom turns
            unit.getId unit_id;
            unit.getTag serial_state Tag.SERIAL_STATE;

            if gt serial_state 1;
              debug_log "Serial was active last turn for:" unit_id;
              debug_log "Serial deactivated for this unit.";
              unit.setTag Tag.SERIAL_STATE 0;
            end;
          end;
          return;
    hitUnit:
      - offset: 23   # for disabling shot
        code: |
          var ptr RuleSoldier soldier_rule;
          var int unit_class;
          
          # check attacker class
          # check skill id

          attacker.getRuleSoldier soldier_rule;
          if neq soldier_rule null;
            soldier_rule.getTag unit_class Tag.CLASS;
            if eq skill_id 21;  # Disabling Shot
              debug_log "Unit hit with disabling shot:" unit;
              battle_game.flashMessage "DISABLED!";
              div power 4;
              unit.setTag Tag.WEAPON_DISABLED 1;
            end;
          end;
          return power part side;
      - offset: 24   # for blademaster
        code: |
          var int blademaster;
          var int sword;
          var ptr RuleItem item_rule;

          attacker.getTag blademaster Tag.BLADEMASTER_STATE;
          
          if and neq blademaster 0 eq battle_action battle_action_hit;
            debug_log "Blademaster is doing melee attack";
            damaging_item.getRuleItem item_rule;
            item_rule.getTag sword Tag.SWORD_TYPE;
            if gt sword 0;
              add power blademaster;
              debug_log " - power increased by:" blademaster;
            end;
          end;
          return power part side;
      - offset: 25   # for untouchable
        code: |
          var int unit_id;
          var int untouchable;
          var int counter;

          unit.getId unit_id;

          unit.getTag untouchable Tag.UNTOUCHABLE_STATE;

          if gt untouchable 0;
            debug_log "Hit against untouchable unit" unit_id;
            unit.getTag counter Tag.UNTOUCHABLE_COUNTER;
            if gt counter 0;
              debug_log " - with counter " counter;
              set power 0;
              debug_log " - DEFLECTED!";
              sub counter 1;
              unit.setTag Tag.UNTOUCHABLE_COUNTER counter;
              battle_game.flashMessage "UNTOUCHABLE!";
            end;
          end;
          return power part side;
      - offset: 26   # for stasis
        code: |
          var int stasis_state;

          unit.getTag stasis_state Tag.STASIS_STATE;

          if gt stasis_state 0;
            debug_log "Unit in stasis was hit. Power reduced to zero.";
            set power 0;
          end;
          return power part side;
      - offset: 27   # for blast padding
        code: |
          var int blast_padding;

          unit.getTag blast_padding Tag.BLAST_PADDING_STATE;

          if gt blast_padding 0;
            sub power 5;  # additional armor layer
            if or eq damaging_type 2 eq damaging_type 3;
              debug_log "Blast padding against damageType Incendiary / HE. Power" power;
              muldiv power blast_padding 100;
              debug_log " - Power reduced to" power;
            end;
          end;
          return power part side;
      - offset: 28   # for threat assessment
        code: |
          var int threat_assessment;
          var int current_time_units;
          var int half_max_time_units;

          unit.getTag threat_assessment Tag.THREAT_ASSESSMENT_STATE;
          unit.getTimeUnits current_time_units;
          unit.getTimeUnitsMax half_max_time_units;
          div half_max_time_units 2;

          if gt threat_assessment 0;
            if gt current_time_units half_max_time_units;
              debug_log "Threat assessment activated. Power" power;
              muldiv power threat_assessment 100;
              debug_log " - Power reduced to" power;
            end;
          end;
          return power part side;
      - offset: 29   # for backstab
        code: |
          var int backstab;
          var ptr RuleArmor armor_rule;
          
          attacker.getTag backstab Tag.BACKSTAB_STATE;

          if gt backstab 0;
            if eq side 2;
              debug_log "Backstab activated with power" power;
              muldiv power backstab 100; # 150 = 150% power increase
              debug_log "  - power adjusted to" power;
            end;
          end;
          unit.getRuleArmor armor_rule;
          debug_log "HIT unit:" unit;
          debug_log " with armor:" armor_rule;
          debug_log " Power:" power; # debug
          return power part side;
      - offset: 30   # for parry
        code: |
          var int unit_id;
          var int parry;
          var int parry_chance;
          var int attacker_x;
          var int attacker_y;
          var int target_x;
          var int target_y;
          var int two_dee_distance_sq;
          var int parry_distance_sq;

          unit.getId unit_id;

          set parry_distance_sq 2; # distance in tiles from which an attack can be parried

          unit.getTag parry Tag.PARRY_STATE;  # hit unit has parry skill?
          set parry_chance parry;  # 40 = 40% chance to parry an attack, can be set on the tag

          if gt parry 0;
            debug_log "Hit against parrying unit" unit_id;

            set two_dee_distance_sq 0;
            mul parry_distance_sq parry_distance_sq;

            attacker.getPosition.getX attacker_x;
            attacker.getPosition.getY attacker_y;

            unit.getPosition.getX target_x;
            unit.getPosition.getY target_y;
            
            sub attacker_x target_x;
            sub attacker_y target_y;

            mul attacker_x attacker_x;
            mul attacker_y attacker_y;

            add two_dee_distance_sq attacker_x;
            add two_dee_distance_sq attacker_y;
            
            debug_log "Parry distance (sq)" parry_distance_sq;
            debug_log "Parry unit attacked from dist (sq)" two_dee_distance_sq;

            if gt two_dee_distance_sq parry_distance_sq;
              debug_log "Too far. No parry possible.";
            else;
              battle_game.randomChance parry_chance;
              if eq parry_chance 1;
                debug_log "PARRY activated, attack negated.";
                set power 0;
              end;
            end;
          end;
          return power part side;
      - offset: 31   # for melee defense
        code: |
          var int unit_id;
          var int melee_defense;

          unit.getId unit_id;
          unit.getTag melee_defense Tag.MELEE_DEFENSE_STATE;  # hit unit has melee defense skill?

          if gt melee_defense 0;
            if eq battle_action battle_action_hit;
              debug_log "Melee hit against melee defense unit" unit_id power;
              muldiv power melee_defense 100; # 50 = 50% damage reduction to health
              debug_log " - Power reduced to" power;
            end;
          end;
          return power part side;
      - offset: 32   # for shadowstrike
        code: |
          var int camo_state;
          var int shadowstrike_state;
          var int turns_since_spotted;
          var int temp;

          attacker.getTag camo_state Tag.PHANTOM_STATE;
          attacker.getTag shadowstrike_state Tag.SHADOWSTRIKE_STATE;
          if and gt shadowstrike_state 0 gt camo_state 0;
            attacker.getTurnsSinceSpotted turns_since_spotted;
            if or eq turns_since_spotted 255 le turns_since_spotted -1;
              # shadowstrike activate
              battle_game.flashMessage "SHADOWSTRIKE!";
              attacker.getTag temp Tag.CRIT_CHANCE_NEXT_HIT;
              add temp shadowstrike_state;
              attacker.setTag Tag.CRIT_CHANCE_NEXT_HIT temp;
            end;
          end;
          return power part side;
      - offset: 33   # for mayhem
        code: |
          var int mayhem;

          attacker.getTag mayhem Tag.MAYHEM_STATE;
          
          if gt mayhem 0;
            if or eq damaging_type 2 eq damaging_type 3 eq battle_action battle_action_autoshoot;
              debug_log "Mayhem triggered (power):" power;
              # EXPLOSIVE / FIRE / AUTOSHOT
              add mayhem 100;
              muldiv power mayhem 100;
              debug_log " - power increased to:" power;
            end;
          end;
          return power part side;
      - offset: 34   # for sting grenades
        code: |
          var int disorient;
          var int stun;
          var int sting_grenades;
          var ptr RuleItem item_rule;

          attacker.getTag sting_grenades Tag.STING_GRENADES_STATE;

          damaging_item.getRuleItem item_rule;
          item_rule.getTag disorient Tag.INFLICT_DISORIENT;

          if and gt sting_grenades 0 gt disorient 0;
            set stun sting_grenades; # = 50% stun chance
            battle_game.randomChance stun;
            if gt stun 0;
              unit.setTag Tag.STUNNED 1;
              unit.setTimeUnits 0;
              debug_log unit "is stunned now!";
            end;
          end;
          return power part side;
      - offset: 35   # for center mass
        code: |
          var int center_mass;
          var int gun_type;
          var ptr RuleItem item_rule;

          damaging_item.getRuleItem item_rule;

          attacker.getTag center_mass Tag.CENTER_MASS_STATE;
          
          if gt center_mass 0;
            item_rule.getTag gun_type Tag.GUN_TYPE;
            if or eq gun_type 2 eq gun_type 3;
              debug_log "Center mass triggered (power):" power;
              # Standard Rifles / Sniper Rifles
              add center_mass 100;
              muldiv power center_mass 100;
              debug_log " - power increased to:" power;
            end;
          end;
          return power part side;
      - offset: 36   # for alpha mike foxtrot
        code: |
          var int amf_state;
          var int temp;
          var int gun_type;
          var ptr RuleItem item_rule;

          damaging_item.getRuleItem item_rule;

          item_rule.getTag gun_type Tag.GUN_TYPE;
          attacker.getTag amf_state Tag.ALPHA_MIKE_FOXTROT_STATE;
          if and gt amf_state 0 eq gun_type 3; # sniper rifles only
            # amf activate
            debug_log "AMF Damage + Crit Damage (inc./power):" amf_state power;
            add power amf_state;

            div amf_state 2;

            attacker.getTag temp Tag.CRIT_DAMAGE_NEXT_HIT;
            add temp amf_state;
            attacker.setTag Tag.CRIT_DAMAGE_NEXT_HIT temp;
          end;
          return power part side;
      - offset: 37   # for guardian
        code: |
          var int guardian;
          var int activation_chance;
          var int turn_side;
          var int action_time_units;
          var int current_time_units;

          set activation_chance 50;
          battle_game.getTag turn_side Tag.TURN_SIDE;

          attacker.getTag guardian Tag.GUARDIAN_STATE;

          if and gt guardian 0 eq turn_side 1; # guardian only activates on enemy turn
            battle_game.randomChance activation_chance;
            if gt activation_chance 1;
              damaging_item.getActionCost.getTimeUnits action_time_units attacker battle_action;
              attacker.getTimeUnits current_time_units;
              add current_time_units action_time_units;

              attacker.setTimeUnits current_time_units;
              debug_log "Guardian Activated! Reaction TU refunded.";
            end;
          end;
                
          return power part side;
      - offset: 38   # for aim
        code: |
          var int aim;
          attacker.getTag aim Tag.AIM_STATE;

          if eq aim 2; # was aiming at the beginning of the turn
            unit.setTag Tag.AIM_STATE 1;  # reset aim bonus after first hit
            debug_log "Aim bonus reset for" unit;
          end;
          return power part side;
      - offset: 39   # for remote stamina hype (friendly targeting test)
        code: |
          var int battle_type;
          var ptr RuleItem item_rule;
          var int energy_max;
          
          damaging_item.getRuleItem item_rule;

          item_rule.getBattleType battle_type;
          debug_log "Unit hit:" unit;
          if eq battle_type 12; # scripted item
            debug_log "Unit hit with scripted item:" unit;
            if or eq battle_action 13 eq battle_action 14;
              debug_log "Unit hit with Mind / Panic:" unit;
              # scripted item, mind control or panic
              unit.getEnergyMax energy_max;
              unit.setEnergy energy_max;
              battle_game.flashMessage "Stamina refreshed";
              set power 0;
            end;
          end;
          return power part side;
    newTurnItem:
      - offset: 23   # for disabling shot
        code: |
          var ptre BattleUnit owner;
          var int weapon_disabled;
          var int temp;
          var int battle_type;
          var ptr RuleItem item_rule;

          item.getOwner owner;

          owner.getTag weapon_disabled Tag.WEAPON_DISABLED;

          if gt weapon_disabled 0;
            sub weapon_disabled 1;
            owner.setTag Tag.WEAPON_DISABLED weapon_disabled;

            item.getRuleItem item_rule;
            item_rule.getBattleType battle_type;
            item.getAmmoQuantity temp;
            debug_log "Dis.Wep. found:" battle_type temp;
            if gt temp 0;
              item.setAmmoQuantity 0;
            end;
          end;
          return;
    tryPsiAttackUnit:
      - offset: 23   # for Scripted Items - Automatic Success
        code: |
          var int battle_type;
          var ptr RuleItem item_rule;
          var int energy_max;
          
          item.getRuleItem item_rule;

          item_rule.getBattleType battle_type;
          
          if eq battle_type 9; # scripted psi amp
            if or eq battle_action 13 eq battle_action 14;
              debug_log "PsiAttack with scripted item. Automatic success!";
              set psi_attack_success 1;
            end;
          end;
          return psi_attack_success;
    accuracyMultiplierBonusStats:
      - offset: 23   # for shadowstrike
        code: |
          var int camo_state;
          var int shadowstrike_state;
          var int turns_since_spotted;

          unit.getTag camo_state Tag.PHANTOM_STATE;
          
          unit.getTag shadowstrike_state Tag.SHADOWSTRIKE_STATE;
          
          if and gt shadowstrike_state 0 gt camo_state 0;
            unit.getTurnsSinceSpotted turns_since_spotted;
            if or eq turns_since_spotted 255 le turns_since_spotted -1;
              # shadowstrike activate
              #debug_log "Shadowstrike Accuracy (org./add.):" bonus 30;
              add bonus 30;
            end;
          end;
          return bonus;
      - offset: 24   # for aim
        code: |
          var int pos_x;
          var int pos_y;
          var int pos_z;
          var int aim_x;
          var int aim_y;
          var int aim_z;
          var int aim;
          var int kneeling;

          unit.getTag aim Tag.AIM_STATE;

          if eq aim 2; # was aiming at the beginning of the turn
            # check pos and kneeling

            unit.isKneeled kneeling;
            if gt kneeling 0;
              unit.getPosition.getX pos_x;
              unit.getPosition.getY pos_y;
              unit.getPosition.getZ pos_z;

              unit.getTag aim_x Tag.AIM_X;
              unit.getTag aim_y Tag.AIM_Y;
              unit.getTag aim_z Tag.AIM_Z;

              if and eq pos_x aim_x eq pos_y aim_y eq pos_z aim_z;
                debug_log "Aim Accuracy (org./add.):" bonus 30;
                add bonus 30;
              end;
            end;
          end;
          return bonus;
    psiDefenceBonusStats:
      - offset: 23   # for steadfast
        code: |
          var int steadfast;

          unit.getTag steadfast Tag.STEADFAST_STATE;

          if gt steadfast 0;
            add bonus steadfast;
          end;
          return bonus;
    damageUnit:
      - offset: 23   # for untouchable
        code: |
          var int unit_health;
          var int untouchable;

          attacker.getTag untouchable Tag.UNTOUCHABLE_STATE;
        
          unit.getHealth unit_health;

          if gt untouchable 0;    # attacker has untouchable skill
            debug_log "Untouchable unit has attacked";
            if ge to_health unit_health;  # unit will be killed
              attacker.setTag Tag.UNTOUCHABLE_COUNTER untouchable;
              debug_log " ... and scored a Kill! Untouchable active.";
            end;
          end;
          return;
      - offset: 24   # for sustain
        code: |
          var int unit_health;
          var int sustain;
          var int id;

          unit.getTag sustain Tag.SUSTAIN_STATE;
        
          unit.getHealth unit_health;

          if gt sustain 0;    # attacked unit has sustain skill
            unit.getId id;
            debug_log "Sutained unit was attacked:" id;
            if ge to_wound 0; # a fatal wound would be inflicted
               mul to_wound 3; # 3 hp damage for every wound
               add to_health to_wound;
               debug_log " .. and a fatal wound would be inflicted. Channeled into HP damage:" to_health;
               set to_wound 0;
            end;
            if ge to_health unit_health;  # unit will be killed
              unit.setTag Tag.SUSTAIN_STATE 0; # deactivate, sustain for this unit, only once
              unit.setTimeUnits 0;
              unit.setEnergy 0;
              debug_log " .. and would be killed. Going to sleep instead. ZZZ..";
              set to_health unit_health;
              sub to_health 1;  # set HP to 1
            end;
          end;
          return;
      - offset: 25   # for death from above
        code: |
          var int unit_health;
          var int attacker_height_level;
          var int victim_height_level;
          var int has_death_from_above;
          var int current_time_units;
          var int action_time_units;

          attacker.getPosition.getZ attacker_height_level;
          unit.getPosition.getZ victim_height_level;

          unit.getHealth unit_health;
          attacker.getTag has_death_from_above Tag.DEATH_FROM_ABOVE_STATE;

          if eq has_death_from_above 1;
            if ge to_health unit_health;  # unit would be killed
              if gt attacker_height_level victim_height_level;
                damaging_item.getActionCost.getTimeUnits action_time_units attacker battle_action;
                attacker.getTimeUnits current_time_units;
                add current_time_units action_time_units;

                attacker.setTimeUnits current_time_units;
                attacker.setTag Tag.DEATH_FROM_ABOVE_STATE 2;
                debug_log "Death from above activated! Action TU refunded.";
              end;
            end;
          end;
          return;
      - offset: 26   # for executioner
        code: |
          var int unit_health;
          var int unit_half_max_health;
          var int executioner;

          unit.getHealth unit_health;
          unit.getHealthMax unit_half_max_health;
          div unit_half_max_health 2;

          attacker.getTag executioner Tag.EXECUTIONER_STATE;

          if gt executioner 0;
            if lt unit_health unit_half_max_health;
              
              debug_log "Executioner activated! " to_health;
              muldiv to_health executioner 100; # 150 = 150% damage to health
              debug_log " - Damaged increased to" to_health;

            end;
          end;
          return;
      - offset: 27   # for slayer
        code: |
          var int unit_health;
          var int unit_max_health;
          var int unit_half_max_health;
          var int slayer_chance;

          unit.getHealth unit_health;
          unit.getHealthMax unit_half_max_health;
          div unit_half_max_health 2;

          attacker.getTag slayer_chance Tag.SLAYER_STATE;

          if gt slayer_chance 0; # attacker must have slayer skill
            if eq battle_action battle_action_hit; # must be melee attack
              if lt unit_health unit_half_max_health; # attacked unit hp < 50%
                battle_game.randomChance slayer_chance;
                if eq slayer_chance 1;  # slayer chance check
                  debug_log "Slayer activated! " to_health;
                  set to_health unit_health;
                  debug_log " - Damaged increased to" to_health;
                end;
              end;  
            end;
          end;
          return;
      - offset: 28   # for reaper
        code: |
          var int unit_health;
          var int state; # 0 = not available, 1 = not activated yet, available 2 = active in this turn
          var int max_time_units;

          attacker.getTag state Tag.REAPER_STATE;

          unit.getHealth unit_health;

          if gt state 0;
            if and eq battle_action battle_action_hit eq damaging_type 7; # action = hit && damage type = melee
              if ge to_health unit_health;                 # would be a kill
                # TRIGGER conditions met
                if eq state 2; # we are active, so refund the action cost
                  debug_log "REAPER triggered! Refunding TU.";
                  battle_game.flashMessage "REAPER!";
                  attacker.getTimeUnitsMax max_time_units;

                  attacker.setTimeUnits max_time_units;    # set the new TU value
                end;
              end;
            end;
          end;
          return;
      - offset: 29   # for shredder
        code: |
          var int weapon_state;
          var int unit_state;
          var ptr RuleItem item_rule;

          weapon_item.getRuleItem item_rule;

          attacker.getTag unit_state Tag.SHREDDER_STATE;
          item_rule.getTag weapon_state Tag.SHREDDER_DAMAGE;

          if and gt weapon_state 0 gt unit_state 0;
            debug_log "Shredder activated (to_armor/unit/weapon):" unit_state weapon_state;
            add to_armor weapon_state;
            debug_log "Shredder adjustment done (to_armor): " to_armor;
          end;
          return;
      - offset: 30   # for rupture
        code: |
          var int weapon_state;
          var int unit_state;
          var int attacker_state;
          var ptr RuleItem item_rule;
          var int increase_damage;
          set increase_damage 0;
          weapon_item.getRuleItem item_rule;

          unit.getTag unit_state Tag.RUPTURE_STATE;
          attacker.getTag attacker_state Tag.RUPTURE_STATE;
          item_rule.getTag weapon_state Tag.RUPTURE_DAMAGE;

          if or eq battle_action battle_action_aimshoot eq battle_action battle_action_autoshoot;            
            if and gt weapon_state 0 eq attacker_state 1;
              # tag unit and increase damage by rupture_state
              unit.setTag Tag.RUPTURE_STATE 2;
              attacker.setTag Tag.RUPTURE_STATE 0;
              set increase_damage 1;
              debug_log "RUPTURED:" unit;
            end;
          end;
          
          if eq unit_state 2;
            debug_log "RUPTURED unit was hit again:" unit;
            set increase_damage 1;
          end;
          
          if eq increase_damage 1;
            debug_log " - Damage to health was:" to_health;
            add weapon_state 100;
            muldiv to_health weapon_state 100; # factor in the weapon rupture state (150 = 150% damage)
            debug_log " - changed to:" to_health;
          end;
        
          return;
      - offset: 31   # for serial
        code: |
          var int unit_health;
          var int state; # 0 = not available, 1 = not activated yet, available 2 = active in this turn
          var int max_time_units;
          var int gun_type;
          var ptr RuleItem item_rule;

          attacker.getTag state Tag.SERIAL_STATE;

          unit.getHealth unit_health;
          damaging_item.getRuleItem item_rule;
          item_rule.getTag gun_type Tag.GUN_TYPE;

          if gt state 0;
            if eq gun_type 3; # sniper rifle
              if ge to_health unit_health;                 # would be a kill
                # TRIGGER conditions met
                if eq state 2; # we are active, so refund the action cost
                  debug_log "SERIAL triggered! Refunding TU.";
                  attacker.getTimeUnitsMax max_time_units;
                  attacker.setTimeUnits max_time_units;    # set the new TU value
                end;
              end;
            end;
          end;
          return;    
    healUnit:
      - offset: 24   # for savior
        code: |
          var int savior;
          var int health_to_heal;

          actor.getTag savior Tag.SAVIOR_STATE;

          if gt savior 0;
            if eq medikit_action_type 1; # heal
              debug_log "Savior activated.";
              debug_log " - Health recovered (org.):" health_recovery;
              set health_recovery savior;
              debug_log " - Health recovered (adj.):" health_recovery;
            end;
          end;

          return;
      - offset: 25   # for field surgeon
        code: |
          var int field_surgeon;
          var int max_health;
          var int cur_health;

          actor.getTag field_surgeon Tag.FIELD_SURGEON_STATE;

          if gt field_surgeon 0;
            
            target.getHealthMax max_health;
            target.getHealth cur_health;

            if and eq medikit_action_type 1 gt max_health cur_health; # heal
              debug_log target "was healed by field surgeon.";
              target.setTag Tag.HEALED_BY_FIELD_SURGEON 1;
            end;
          end;

          return;    
    returnFromMissionUnit:
      - offset: 23   # for field surgeon
        code: |
          var int healed_by_field_surgeon;
          var int factor;

          unit.getTag healed_by_field_surgeon Tag.HEALED_BY_FIELD_SURGEON;

          if gt healed_by_field_surgeon 0;
            debug_log unit " is under Field Surgeon effect. Recovery time changed from" recovery_time;
            set factor 100;
            sub factor healed_by_field_surgeon;
            muldiv recovery_time factor 100;
            debug_log unit " - to" recovery_time;
          end;
          return;
    recolorUnitSprite:   
      - offset: 23   # for phantom
        code: |
          var int camo_state;
          var int turns_since_spotted;
          var int temp;

          unit.getTag camo_state Tag.PHANTOM_STATE;        

          if gt camo_state 0;
            unit.getTurnsSinceSpotted turns_since_spotted;
            if and neq turns_since_spotted 255 gt turns_since_spotted -1;
              # just been spotted during own turn! blink!
              set temp anim_frame;
              wavegen_tri temp 8 16 15;
              mul temp -1;
              add temp 8;
              add_shade new_pixel temp;
            else;
              add_shade new_pixel 6; # PHANTOM working, darken the armor
            end;
          end;

          return new_pixel;
    visibilityUnit:
      - offset: 23   # for phantom
        code: |
          var int observer_x;
          var int observer_y;
          var int target_x;
          var int target_y;
          var int two_dee_distance_sq;
          var int camo_distance_sq;

          target_unit.getTag camo_distance_sq Tag.PHANTOM_STATE;

          if neq camo_distance_sq 0;
            set two_dee_distance_sq 0;
            mul camo_distance_sq camo_distance_sq;

            observer_unit.getPosition.getX observer_x;
            observer_unit.getPosition.getY observer_y;

            target_unit.getPosition.getX target_x;
            target_unit.getPosition.getY target_y;
            
            sub observer_x target_x;
            sub observer_y target_y;

            mul observer_x observer_x;
            mul observer_y observer_y;

            add two_dee_distance_sq observer_x;
            add two_dee_distance_sq observer_y;
            
            debug_log "Camo units safe distance (sq)" camo_distance_sq;
            debug_log "Camo unit may be visible in distance (sq)" two_dee_distance_sq;

            if gt two_dee_distance_sq camo_distance_sq;
              debug_log "PHANTOM working!";
              set current_visibility 0;   # stay unseen
            else;
              debug_log "Camo unit spotted!";
              set current_visibility 100; # expose
            end;
          end;
          return current_visibility visibility_mode;
    applySoldierBonuses:
      - offset: 23
        code: |
          var int id;
          var int has_reaper;
          var int has_untouchable;
          var int has_lightning_reflexes;
          var int has_death_from_above;
          var int has_blast_padding;
          var int has_phantom;
          var int has_sustain;
          var int has_executioner;
          var int has_threat_assessment;
          var int has_backstab;
          var int has_blademaster;
          var int has_field_medic;
          var int has_shadowstrike;
          var int has_shredder;
          var int has_amf;

          unit.getId id;

          # class skills are awarded via molding transformations otherwise same procedure
          soldier_bonus.getTag has_blast_padding Tag.BLAST_PADDING;
          soldier_bonus.getTag has_blademaster Tag.BLADEMASTER;
          soldier_bonus.getTag has_field_medic Tag.FIELD_SPECIALIST;
          soldier_bonus.getTag has_death_from_above Tag.DEATH_FROM_ABOVE;
          soldier_bonus.getTag has_shadowstrike Tag.SHADOWSTRIKE;
          soldier_bonus.getTag has_shredder Tag.SHREDDER;
          soldier_bonus.getTag has_amf Tag.ALPHA_MIKE_FOXTROT;

          # these skills are trainable via transformation -> bonus
          soldier_bonus.getTag has_reaper Tag.REAPER;
          soldier_bonus.getTag has_untouchable Tag.UNTOUCHABLE;
          soldier_bonus.getTag has_lightning_reflexes Tag.LIGHTNING_REFLEXES;
          soldier_bonus.getTag has_phantom Tag.PHANTOM;
          soldier_bonus.getTag has_sustain Tag.SUSTAIN;
          soldier_bonus.getTag has_executioner Tag.EXECUTIONER;
          soldier_bonus.getTag has_threat_assessment Tag.THREAT_ASSESSMENT;
          soldier_bonus.getTag has_backstab Tag.BACKSTAB;
          
          if gt has_reaper 0;
            debug_log "Unit" id "- Reaper Skill found";
            unit.setTag Tag.REAPER_STATE 1;
          end;

          if gt has_untouchable 0;
            debug_log "Unit" id "-  Untouchable Skill found at" has_untouchable;
            unit.setTag Tag.UNTOUCHABLE_STATE has_untouchable;
          end;

          if gt has_lightning_reflexes 0;
            debug_log "Unit" id "-  Lightning Reflexes Skill found at" has_lightning_reflexes;
            unit.setTag Tag.LIGHTNING_REFLEXES_STATE has_lightning_reflexes;
          end;

          if gt has_death_from_above 0;
            debug_log "Unit" id "-  Death from Above Skill found at" has_death_from_above;
            unit.setTag Tag.DEATH_FROM_ABOVE_STATE has_death_from_above;
          end;

          if gt has_blast_padding 0;
            debug_log "Unit" id "-  Blast padding Skill found at" has_blast_padding;
            unit.setTag Tag.BLAST_PADDING_STATE has_blast_padding;
          end;

          if gt has_phantom 0;
            debug_log "Unit" id "-  phantom Skill found at" has_phantom;
            unit.setTag Tag.PHANTOM_STATE_ORIGINAL has_phantom;
            unit.setTag Tag.PHANTOM_STATE has_phantom;
          end;

          if gt has_sustain 0;
            debug_log "Unit" id "-  Sustain Skill found";
            unit.setTag Tag.SUSTAIN_STATE 1;
          end;

          if gt has_executioner 0;
            debug_log "Unit" id "-  Executioner Skill found at" has_executioner;
            unit.setTag Tag.EXECUTIONER_STATE has_executioner;
          end;

          if gt has_threat_assessment 0;
            debug_log "Unit" id "-  Threat Assessment Skill found at" has_threat_assessment;
            unit.setTag Tag.THREAT_ASSESSMENT_STATE has_threat_assessment;
          end;

          if gt has_backstab 0;
            debug_log "Unit" id "-  Backstab Skill found at" has_backstab;
            unit.setTag Tag.BACKSTAB_STATE has_backstab;
          end;

          if gt has_blademaster 0;
            debug_log "Unit" id "-  Blademaster Skill found at" has_blademaster;
            unit.setTag Tag.BLADEMASTER_STATE has_blademaster;
          end;

          if gt has_field_medic 0;
            debug_log "Unit" id "-  Field Specialist Skill found at" has_field_medic;
            unit.setTag Tag.FIELD_SPECIALIST_STATE has_field_medic;
          end;

          if gt has_shadowstrike 0;
            debug_log "Unit" id "-  Shadowstrike Skill found at" has_shadowstrike;
            unit.setTag Tag.SHADOWSTRIKE_STATE has_shadowstrike;
          end;

          if gt has_shredder 0;
            debug_log "Unit" id "-  Shredder Skill found at" has_shredder;
            unit.setTag Tag.SHREDDER_STATE has_shredder;
          end;

          if gt has_amf 0;
            debug_log "Unit" id "-  AMF Skill found at" has_amf;
            unit.setTag Tag.ALPHA_MIKE_FOXTROT_STATE has_amf;
          end;
          return;

ufopaedia:
  - id: STR_MILITARY_MOLDING
    type_id: 7 # text only
    image_id: UFOPAEDIA_IMG_MOLDING_CPAL
    section: STR_MILITARY_MOLDING
    text: STR_UFOPAEDIA_MILITARY_MOLDING
    text_width: 260
  - id: STR_RANGER
    type_id: 7 # text & image
    section: STR_MILITARY_MOLDING
    image_id: UFOPAEDIA_IMG_RANGER_CPAL
    text: STR_UFOPAEDIA_RANGER
    text_width: 158
  - id: STR_RANGER_SKILLS
    type_id: 8 # text & image
    section: STR_MILITARY_MOLDING
    text: STR_UFOPAEDIA_RANGER_SKILLS
  - id: STR_GRENADIER
    type_id: 7 # text & image
    section: STR_MILITARY_MOLDING
    image_id: UFOPAEDIA_IMG_GRENADIER_CPAL
    text: STR_UFOPAEDIA_GRENADIER
    text_width: 143
  - id: STR_GRENADIER_SKILLS
    type_id: 8 # text & image
    section: STR_MILITARY_MOLDING
    text: STR_UFOPAEDIA_GRENADIER_SKILLS
  - id: STR_SNIPER
    type_id: 7 # text & image
    section: STR_MILITARY_MOLDING
    image_id: UFOPAEDIA_IMG_SHARPSHOOTER_CPAL
    text: STR_UFOPAEDIA_SNIPER
    text_width: 158
  - id: STR_SNIPER_SKILLS
    type_id: 8 # text & image
    section: STR_MILITARY_MOLDING
    text: STR_UFOPAEDIA_SNIPER_SKILLS
  - id: STR_SPECIALIST
    type_id: 7 # text & image
    section: STR_MILITARY_MOLDING
    image_id: UFOPAEDIA_IMG_SPECIALIST_CPAL
    text: STR_UFOPAEDIA_SPECIALIST
    text_width: 158
  - id: STR_SPECIALIST_SKILLS
    type_id: 8 # text & image
    section: STR_MILITARY_MOLDING
    text: STR_UFOPAEDIA_SPECIALIST_SKILLS
  - id: STR_PSI_OPERATIVE
    type_id: 7 # text & image
    section: STR_MILITARY_MOLDING
    image_id: UFOPAEDIA_IMG_PSIOP_CPAL
    text: STR_UFOPAEDIA_PSI_OP
    text_width: 158
  - id: STR_SKILL_AMP
    type_id: 4 # equipment
    section: STR_WEAPONS_AND_EQUIPMENT
    text: STR_UFOPAEDIA_SKILL_AMP

extraStrings:
  - type: en-US
    strings:
      STR_SOLDIER_EXPERIENCE: Combat Experience
      STR_SOLDIER_EXPERIENCE_DESCRIPTION: Awarded for missions and kills in the service of XCOM.
      STR_SKILL_AMP: Skill Amplifier
      STR_ELITE_CLASS_SKILL: Activate Elite Skill
      STR_CLASS_SKILL: Activate Class Skill
      STR_RANGER_CLASS_SKILL: Run & Gun
      STR_SNIPER_CLASS_SKILL: Headshot
      STR_SPECIALIST_CLASS_SKILL: Paramedic
      STR_NO_USES_LEFT: Exhausted all activations
      STR_MANA: "BATTLE FOCUS"
      STR_MANA_POOL: "FOCUS POINTS"
      STR_MANA_MISSING: "FOCUS MISSING"
      STR_MANA_RECOVERY: "FOCUS RECOVERY"
      STR_NOT_ENOUGH_MANA: "Not Enough Focus!"
      STR_MANA_ABBREVIATION: "FOC"
      STR_MANA_CURRENT: "CURRENT FOCUS"
      STR_MANA_NORMALIZED: "NORMALIZED FOCUS"
      STR_COST_MANA: "focus"
      manaExperience: "Focus experience"
      manaRequired: "Focus required?"
      ToMana: "Focus dmg multiplier"
      RandomMana: "Focus dmg RNG?"
      mana: "Focus"
      manaRecoveryPerDay: "Focus per day"
      STR_RANGER: Ranger
      STR_GRENADIER: Grenadier
      STR_SNIPER: Sniper
      STR_PSI_OPERATIVE: Psi-Op
      STR_SPECIALIST: Specialist
      STR_RANGER_SKILLS: Ranger Skills
      STR_GRENADIER_SKILLS: Grenadier Skills
      STR_SNIPER_SKILLS: Sniper Skills
      STR_SPECIALIST_SKILLS: Specialist Skills
      STR_PSI_OP_SKILLS: Psi Operative Skills
      STR_RANGER_MOLDING: Ranger molding
      STR_GRENADIER_MOLDING: Grenadier molding
      STR_SNIPER_MOLDING: Sniper molding
      STR_SPECIALIST_MOLDING: Specialist molding
      STR_PSI_OPERATIVE_MOLDING: Psi-Op molding
      STR_RANGER_ADVANCED_TRAINING: Advanced Ranger Training
      STR_GRENADIER_ADVANCED_TRAINING: Advanced Grenadier Training
      STR_SNIPER_ADVANCED_TRAINING: Advanced Sniper Training
      STR_SPECIALIST_ADVANCED_TRAINING: Advanced Specialist Training
      STR_RANGER_ELITE_TRAINING: Elite Ranger Training
      STR_GRENADIER_ELITE_TRAINING: Elite Grenadier Training
      STR_SNIPER_ELITE_TRAINING: Elite Sniper Training
      STR_SPECIALIST_ELITE_TRAINING: Elite Specialist Training
      STR_ROOKIE_RANGER_RANK: Rk. Ranger
      STR_SQUADDIE_RANGER_RANK: Sq. Ranger
      STR_SERGEANT_RANGER_RANK: Sgt. Ranger
      STR_CAPTAIN_RANGER_RANK: Cpt. Ranger
      STR_COLONEL_RANGER_RANK: Col. Ranger
      STR_COMMANDER_RANGER_RANK: Cdr. Ranger
      STR_ROOKIE_GRENADIER_RANK: Rk. Grenadier
      STR_SQUADDIE_GRENADIER_RANK: Sq. Grenadier
      STR_SERGEANT_GRENADIER_RANK: Sgt. Grenadier
      STR_CAPTAIN_GRENADIER_RANK: Cpt. Grenadier
      STR_COLONEL_GRENADIER_RANK: Col. Grenadier
      STR_COMMANDER_GRENADIER_RANK: Cdr. Grenadier
      STR_ROOKIE_SNIPER_RANK: Rk. Sniper
      STR_SQUADDIE_SNIPER_RANK: Sq. Sniper
      STR_SERGEANT_SNIPER_RANK: Sgt. Sniper
      STR_CAPTAIN_SNIPER_RANK: Cpt. Sniper
      STR_COLONEL_SNIPER_RANK: Col. Sniper
      STR_COMMANDER_SNIPER_RANK: Cdr. Sniper
      STR_ROOKIE_PSI_OPERATIVE_RANK: Rk. Psi-Op
      STR_SQUADDIE_PSI_OPERATIVE_RANK: Sq. Psi-Op
      STR_SERGEANT_PSI_OPERATIVE_RANK: Sgt. Psi-Op
      STR_CAPTAIN_PSI_OPERATIVE_RANK: Cpt. Psi-Op
      STR_COLONEL_PSI_OPERATIVE_RANK: Col. Psi-Op
      STR_COMMANDER_PSI_OPERATIVE_RANK: Cdr. Psi-Op
      STR_ROOKIE_SPECIALIST_RANK: Rk. Specialist
      STR_SQUADDIE_SPECIALIST_RANK: Sq. Specialist
      STR_SERGEANT_SPECIALIST_RANK: Sgt. Specialist
      STR_CAPTAIN_SPECIALIST_RANK: Cpt. Specialist
      STR_COLONEL_SPECIALIST_RANK: Col. Specialist
      STR_COMMANDER_SPECIALIST_RANK: Cdr. Specialist
      STR_RANGER_INITIAL_BONUS: "Initial Ranger Molding"
      STR_RANGER_ADVANCED_BONUS: "Advanced Ranger"
      STR_RANGER_ELITE_BONUS: "Elite Ranger"
      STR_GRENADIER_INITIAL_BONUS: "Initial Grenadier Molding"
      STR_GRENADIER_ADVANCED_BONUS: "Advanced Grenadier"
      STR_GRENADIER_ELITE_BONUS: "Elite Grenadier"
      STR_SNIPER_INITIAL_BONUS: "Initial Sniper Molding"
      STR_SNIPER_ADVANCED_BONUS: "Advanced Sniper"
      STR_SNIPER_ELITE_BONUS: "Elite Sniper"
      STR_SPECIALIST_INITIAL_BONUS: "Initial Specialist Molding"
      STR_SPECIALIST_ADVANCED_BONUS: "Advanced Specialist"
      STR_SPECIALIST_ELITE_BONUS: "Elite Specialist"
      STR_UNTOUCHABLE_BONUS: "Untouchable"
      STR_LIGHTNING_REFLEXES_BONUS: "Lightning Reflexes"
      STR_DEATH_FROM_ABOVE_BONUS: "Death from above"
      STR_BLAST_PADDING_BONUS: "Blast Padding"
      STR_PHANTOM_BONUS: "Phantom"
      STR_SUSTAIN_BONUS: "Sustain"
      STR_EXECUTIONER_BONUS: "Executioner"
      STR_THREAT_ASSESSMENT_BONUS: "Threat Assessment"
      STR_BACKSTAB_BONUS:  "Backstab"
      STR_BLADEMASTER_BONUS: "Blademaster"
      STR_FIELD_SPECIALIST_BONUS: "Field Specialist"
      STR_UFOPAEDIA_RANGER: "The Ranger serves as our primary reconnaissance unit, capable of moving independently in concealment while engaging enemies at close range using extensive training in swordsmanship.{NEWLINE}{NEWLINE}INITIAL SKILLS>{NEWLINE}Blademaster - Run & Gun{NEWLINE}{NEWLINE}ADVANCED SKILLS>{NEWLINE}Phantom - Shadowstrike{NEWLINE}{NEWLINE}ELITE SKILLS>{NEWLINE}Untouchable - Reaper"
      STR_UFOPAEDIA_GRENADIER: "A class specialising in high fire power and area damage with some support capabilities. The Grenadier is at its strongest vs armored or high health enemies, but can also be really useful in situations were the enemies cluster together.{NEWLINE}{NEWLINE}INITIAL SKILLS>{NEWLINE}Shredder - Heavy Rocket{NEWLINE}{NEWLINE}ADVANCED SKILLS>{NEWLINE}Blast Padding - Mayhem{NEWLINE}{NEWLINE}ELITE SKILLS>{NEWLINE}Sting Grenades - Rupture"
      STR_UFOPAEDIA_SNIPER: "A class able to inflict massive long range damage on enemy targets from a position of safety. They are good at inflicting critical hits, and can augment the chances further with their special Headshot ability.{NEWLINE}{NEWLINE}INITIAL SKILLS>{NEWLINE}Death from above - Headshot{NEWLINE}{NEWLINE}ADVANCED SKILLS>{NEWLINE}Aim - Center Mass{NEWLINE}{NEWLINE}ELITE SKILLS>{NEWLINE}Alpha Mike Foxtrot - Serial"
      STR_UFOPAEDIA_SPECIALIST: "Soldiers trained in the Specialist class serve as both field medics and logistical support to the squad they are attached to. Equipped with medical supplies, smoke grenades and other items, these troops ensure the safe return of all units deployed in the field.{NEWLINE}{NEWLINE}INITIAL SKILLS>{NEWLINE}Guardian - Paramedic{NEWLINE}{NEWLINE}ADVANCED SKILLS>{NEWLINE}Steadfast - Field Surgeon{NEWLINE}{NEWLINE}ELITE SKILLS>{NEWLINE}Savior - Ever Vigilant"
      STR_UFOPAEDIA_PSI_OP: "A mysterious new branch of study for XCOM, the Psionic Operative utilizes their mental abilities to great effect to boost their allies and cripple the will of enemies.{NEWLINE}{NEWLINE}INITIAL SKILLS>{NEWLINE}??? - ???{NEWLINE}{NEWLINE}ADVANCED SKILLS>{NEWLINE}??? - ???{NEWLINE}{NEWLINE}ELITE SKILLS>{NEWLINE}??? - ???"
      STR_MILITARY_MOLDING: "MILITARY MOLDING"
      STR_UFOPAEDIA_MILITARY_MOLDING: "XCOM units of rank squaddie or higher are eligible for military molding. Through hard training, genetical manipulation and cybernetical enhancements the soldiers are imprinted with a specialized combat protocol.{NEWLINE}{NEWLINE}The process is irreversible.{NEWLINE}{NEWLINE}After the initial molding process an advanced and elite training program become available to more experienced soldiers. Each stage of training will unlock two additional combat abilities.{NEWLINE}{NEWLINE}Equip your elite troops with a skill amplifier in order to unlock their full potential and access their final skill."
      STR_UFOPAEDIA_RANGER_SKILLS: "BLADEMASTER> Deal increased damage on all sword attacks.{NEWLINE}{NEWLINE}RUN & GUN> Take an extra action after dashing.{NEWLINE}{NEWLINE}PHANTOM> Begin a mission in concealment.{NEWLINE}{NEWLINE}SHADOWSTRIKE> While concealed, gain bonus aim and bonus critical chance when attacking enemies.{NEWLINE}{NEWLINE}UNTOUCHABLE> If you score a kill during your turn, the next two attacks against you during the enemy turn will miss.{NEWLINE}{NEWLINE}REAPER> A devastating chain melee attack where every kill scored will grant an extra action."
      STR_UFOPAEDIA_GRENADIER_SKILLS: "SHREDDER> Your cannon attacks shred armor. Higher rank weapons shred more points of armor.{NEWLINE}{NEWLINE}HEAVY ROCKET> Fire a rocket using an equipped launcher.{NEWLINE}{NEWLINE}BLAST PADDING> Your gear includes layers of extra padding and blast plates, granting bonus points of Armor and 66% less damage from explosive attacks.{NEWLINE}{NEWLINE}MAYHEM> Confers additional damage to all area of effect weapons & auto shooting guns.{NEWLINE}{NEWLINE}STING GRENADES> Your flashbang grenades have a 50% chance to stun enemies for one turn in the flashbang's Area of Effect.{NEWLINE}{NEWLINE}RUPTURE> A Rupture shot deals critical damage and ensures that the target takes additional damage from all attacks in the future."
      STR_UFOPAEDIA_SNIPER_SKILLS: "DEATH FROM ABOVE> Killing an enemy at a lower elevation with your sniper rifle will grant an additional action once per turn.{NEWLINE}{NEWLINE}HEADSHOT> Fire a shot with +30% critical chance and extra damage on critical hits.{NEWLINE}{NEWLINE}AIM> Kneeling now confers 30% firing accuracy to the first shot on the following turn.{NEWLINE}{NEWLINE}CENTER MASS> You do additional points of base damage when using guns.{NEWLINE}{NEWLINE}ALPHA MIKE FOXTROT> You do additional points of base damage and additional points of crit damage with your primary weapon.{NEWLINE}{NEWLINE}SERIAL> A powerful chained shot ability. For every kill made with your sniper rifle, your actions will be refunded."
      STR_UFOPAEDIA_SPECIALIST_SKILLS: "GUARDIAN> With every successful Overwatch shot, there is a 50% chance that the action cost will be refunded.{NEWLINE}{NEWLINE}PARAMEDIC> This unit may use its medikit with drastically reduced action costs.{NEWLINE}{NEWLINE}STEADFAST> (Almost) Never panic as a result of getting wounded, allies panicking, allies getting wounded or killed, or the intimidation ability.{NEWLINE}{NEWLINE}FIELD SURGEON> Reduces Wounded timer on soldiers who sustained HP damage.{NEWLINE}{NEWLINE}SAVIOR> Medikits restore health per use.{NEWLINE}{NEWLINE}EVER VIGILANT> At the start of the enemy turn your time units are refilled for free reaction fire."
      STR_UFOPAEDIA_SKILL_AMP: "The skill amplifier is an experimental piece of technology. It is directly connected to the brain of the wearer via the central nervous system and grants the soldier using it extraordinary abilities."
      STR_SKILL_NEEDS_ITEM: "Skill needs item!"
      STR_HEAVY_ROCKET: Heavy Rocket
      STR_RAPID_DEPLOYMENT: Rpd. Deployment
      STR_SHREDDER_ROCKET: Shred Rocket
      STR_RAGE_BURST: Rage Burst
      STR_RUPTURE: Rupture
      STR_RUN_AND_GUN: Run and Gun
      STR_SLASH: Slash
      STR_CONCEAL: Conceal
      STR_RAPID_FIRE: Rapid Fire
      STR_HEADSHOT: Headshot
      STR_DOUBLE_TAP: Double Tap
      STR_SERIAL: Serial
      STR_DISABLING_SHOT: Disabling Shot
      STR_QUICK_AIM: Quick Aim
      STR_PARAMEDIC: Paramedic
      STR_AID_PROTOCOL: Aid Protocol
      STR_COMBAT_PROTOCOL: Combat Protocol
      STR_INTERFERENCE: Interference
      STR_RESTORATION: Restoration
      STR_WAR_CRY: War Cry

statStrings:
  - string: "Dis"
    Tag.DISORIENTED: [1, ~]
  - string: "Psi" #above average psi skill
    psiSkill: [40, ~]
  - string: "Elite"
    health: [30, ~]
    strength: [40, ~]
    reactions: [60, ~]
    firing: [60, ~]
    stamina: [60, ~]
  #--- accuracy/long range class ---
  - string: "Snipr"
    firing: [70, ~]
    reactions: [60, ~]
  - string: "Mksmn"
    firing: [70, ~]
  #--- mobility heavy class ---
  - string: "HvySct" #mobile medium range
    health: [30, ~]
    strength: [40, ~]
    reactions: [50, ~]
    stamina: [60, ~]
    tu: [60, ~]
  - string: "HvyAsslt" #mobile close range
    health: [30, ~]
    strength: [40, ~]
    reactions: [~, 49]
    stamina: [70, ~]
    tu: [60, ~]
  - string: "HvySupp"
    health: [30, ~]
    strength: [40, ~]
    bravery: [70, ~]
    stamina: [60, ~]
    tu: [50, ~]
  #--- mobility class ---
  - string: "Sct" #mobile medium range
    reactions: [50, ~]
    stamina: [60, ~]
    tu: [60, ~]
  - string: "Asslt" #mobile close range
    reactions: [~, 49]
    stamina: [70, ~]
    tu: [60, ~]
  - string: "Supp"
    bravery: [70, ~]
    stamina: [60, ~]
    tu: [50, ~]
  #--- heavy class ---
  - string: "Hvy"
    health: [30, ~]
    strength: [40, ~]
  #--- speciality class ---
  - string: "Spclst" #good at throwing & melee
    stamina: [60, ~]
    tu: [50, ~]
    strength: [40, ~]
    throwing: [70, ~]
    melee: [70, ~]
  - string: "Grndr" #good at throwing
    strength: [40, ~]
    throwing: [70, ~]
  - string: "Melee" #mobile and good at hand2hand
    stamina: [60, ~]
    tu: [50, ~]
    strength: [40, ~]
    melee: [70, ~]

extraSprites:
  - type: SPICONS.DAT
    width: 32
    height: 24
    files:
      2: Resources/UI/SPICON_RANGER.png
      3: Resources/UI/SPICON_HEAVY.png
      4: Resources/UI/SPICON_SNIPER.png
      5: Resources/UI/SPICON_SPECIALIST.png
      6: Resources/UI/SPICON_PSIOP.png
  - type: UFOPAEDIA_IMG_MOLDING_CPAL
    singleImage: true
    width: 320
    height: 200
    files:
      0: Resources/UFOPedia/xcom_molding_new.png
  - type: UFOPAEDIA_IMG_RANGER_CPAL
    singleImage: true
    width: 320
    height: 200
    files:
      0: Resources/UFOPedia/xcom2_ranger.png
  - type: UFOPAEDIA_IMG_GRENADIER_CPAL
    singleImage: true
    width: 320
    height: 200
    files:
      0: Resources/UFOPedia/xcom2_grenadier.png
  - type: UFOPAEDIA_IMG_SPECIALIST_CPAL
    singleImage: true
    width: 320
    height: 200
    files:
      0: Resources/UFOPedia/xcom2_specialist.png
  - type: UFOPAEDIA_IMG_SHARPSHOOTER_CPAL
    singleImage: true
    width: 320
    height: 200
    files:
      0: Resources/UFOPedia/xcom2_sharpshooter.png
  - type: UFOPAEDIA_IMG_PSIOP_CPAL
    singleImage: true
    width: 320
    height: 200
    files:
      0: Resources/UFOPedia/xcom2_psiop.png

# Reference Information
# dmg calc.
# power of hitUnit / original_damage of damageUnit = (power of weapon +/- randomRange%) * damageModifier(Armor,Type)
# damage of damageUnit = (power output of hitUnit) - Armor(Side) * ArmorEffectiveness
# output of damageUnit is applied immediately

# Vanilla Starting Stats & Caps
# tu: 50-60 (80)
# stamina: 40-70 (100)
# health: 25-40 (60)
# bravery: 10-60 (100)
# reactions: 30-60 (100)
# firing: 40-70 (120)
# throwing: 50-80 (120)
# strength: 20-40 (70)
# psiStrength: 0-100
# psiSkill: 0 (170)
# melee: 20-40 (120)